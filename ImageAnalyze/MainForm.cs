/* Title:Gmage
 * Author:Iyui
 * Iyui.Github.com
 *             .CXBBXC' -0B0BXB0C??HOvvHHOOOO7CO?OCC0%?OH?CCC7O?C77H?777?O>>>>7C>>>CO>+v+>>>>777>=>7CC7?C-``'_:=>7777777777COCCCOOCCCCCCCC77C7C77777>77>'..``.:COOO
           `7XBBB7`  ~X00BB0OOH?0>~=OHOOO?7OOOOCCH%HOHO7C77?O77CHO77O?C>>>>C7>>>OO7>>>>>>>C77>v+>7C>?>'```'_-_+C777777CC7CCCCCCCCCCCCCCCC77777777>>>>_.`````~?HO
          `OX000=.   +X00BBHCH??B+^v+?OO?CCOOOOCCHXB??77C7C?C77OHC>C??7>>>>C>>>>OO7>>>7>>7C>7>vv++C>O+`````'-:>777777>7CCC7CCCCCCCCCCCCC77777>>>>vv+>:.````. :HH
         .CX000^    .7B00BBO?H?HBC:vvOO??>COC?OCCO0X0C7777??77>?H7>O?C>>>>77>>>7OO>>>>77>7C7>>==vv7>O=``````'_+C77777>>>7CCCCOOCCCCCCC7C77777>>+=::=>~`'`'..  =B
         :B0B0:     .OB0BBHCH??HX0:=v7?H77OCOHOCCC?X077777HO>>7??>C?O>>>>>>>>>>7??>>>>C7>77>7+=~~v7>C~``.````'_>C777>7777COOOOOCCCCCCC7CC777C7+^_--^+=``'`.....>
        '?B00=  .   .?B0BB?OH??HX0~~++??>COC?HOCCCC0XC7C7C0C+>CHO>OO>>>>>>>77>>O?O>>>>CC>777>v~~^+7>C^``..````-:COC7777777COOOOOOCCOCCCCC777C>^--:_:v~'''..... .
       `OB0H:    .. 'HB000O?H??0X0C^++?77OCOH?OCC7CCBB777OH>+7CO77C>>>>>>>7C>>7O?C>>>+CO>77>>v~:^>7>7_``...```'-:CHOOCC77777OO?OOOOOOCCCOC7>+~__=+~_^:''`.... . 
       +B00:     `. '0000HO????BB00=v7C>COOOHOOOCCCCOX?>7??++7+C7>>>>>>>>>CO>>C?O7>>>+CO7C>>+v=_~>>7+-`....````--~HH?????CC7CO??OOOOOCOCC>=^__^+7>~-_-''..... . 
      _00B=     .^` -B000H????HB0H0O+C77OCC??CO?C7CCC?XO>HCv>7=C7>>>>>>>>7CO>>C?C>>>>vCO7C>>+v~_=+>7='......````-_CH?HH?HH??O??????OOOC7v^_:~=>7C7~---'`.....   
      7BBC.     `=. -B000?????HX0HHHOO>COCO?CCOCOC77CCHB?07v7+=C>>>>>>>>77>C>>O?>7>>>vOOCC>>+v~:vv>>^_-`'`..````''~???????HHHHHH?????OO>vv+>COCCCCv::=-.... ..  
     -0B?'      '>. _B00HO????0X0HHH0O>OCCOOCCOC??C7>7CC0?++C~=C>>>>>>>7C>>>>>?C+>>>++O?7>>>vv~^=~CO>=-``....``'^^^O??HHHHHH?HHH?????O?O?OO?HHOOOOC7>O~ ..... . 
     +X0^       _C` -000HO????BX0HH?H77OCCOCCCOCHOCCC>7COO7>>:vC+>>>>>>C7>>>>7?++>>>v+OOv7>>=v^~=+H7:`.......```^77CCO?OOOOCCHHH?H?H?O?HH???HH???OOOO?+... ...  
    'HX7        :?` _000????O?XBHHH0?>COCCCCCCOOHCC7CC77C77?v_+>v>>>>>77>>>>>C?~>>>>v+H+v>>>~=^>7>C~-``......```'^OO777CCCCCOHHHHHHH?O??HH?H00H????OO?O` ... .  
    ~XH-        _0^ :B00??????BBHHX$?+COCCCCCCCOHCC777C7>7+Cv_+7>>++>>C7>>7>7?7~7>>>=CC^+>>v+>+>:=7^'`....```.'''~>COCC7CCCCOHHHHHHH?O?HHH?HBB0HHHH??H0: .  . . 
   .?B=         'HH_^B0H???H?OH$B?B$0>OCCCCCC7OOHCC77>7+=77C>>7C?O77777>>>7>O?~~7>>++?=:7>7COv:^_>v_``......```-_+C77OHC7CCCOHH0HHHH?O?H0HH0BB0HHH0HH007   . . .
   _BH-         .70O?00H?HH?O?B%BHHXBCCCCCCCC7COHCC7>77~v>>=^=>7OOO?O?OC77>7?O^=7>>v>7_~>CH7v^^^:+~-``.......```-^777OHHC7CC?H?HHHHH?CH00HH0BBB00000H000'     . 
   =XO`          ^HHHHH???OO?X0B0BHHB?OCOCCCC7O?HCC7>7>:+>>^_:v+>>7CC?O7CO7OHO=>C>>=>~-=?0>~=^~::+:'`........```'_+O7CHHHCCC?HHHHHHH?CH00HH0XXB00000HB0B=       
   7B+           `>H?OOOOO?HXX?H00?CHHCC?CCCC7C?HCC777=:>>=:_:=+>v+>7O>>C>7??=:>7>v==_vH07v=~:~_^+_'`.....``````'-^7C7OHH?CCH?HHHHHHOCH00H0BXXB000000B0B?`    . 
  .?0_            =BHHH?HBXXX0?HHH?>C?7H?CCC77COCOC77>^:>v:__:=>+v>>?C>C>>O?>_^>>+~~~?BC>+==^::-~v'`........`.`.'__:777?HH?????HHHH?OCH00H0BXXB000000000B=    ..
  'H?.           `?B00BXXXXXX?HHHH?>7O?H?OOOOCC7+OC77>:^7=___:v>v++7?777>7??~_~7>v:>X$=v>>==^::'+_``...`..``....`-:_~C7C?HH?C??H?HHOOCH00H0XXXB000000000BO.    .
  -07            ^B0H0XXXXBXB?HH0HO>>>HHOCC7CO?O+OC77v-^7=___:v>v+vOO77>>CH+__=>+~>$$v_>>+=~:~--v```.............'^>~>C7O?HOC?HH?HHOCCHB00BXXXB0000000000H-    .
  -0=           _H00HBXXXXXXH?0B0HO+>OH?CCC777C?CH?>7~-^7=___^++v=+?O++>7?C:__v>+C$%>'^7>v=^:^`^:```.............'-vC7777O?CO?HH?H?OCC0000BXXXB0000000HHH0>.  . 
  'H^          -HBHHBXXXXXXBO0XB0?C+7HH?CCC77Cv+=?B0>-'^7^-__=+=v~7?>:+7O?~-::v>0#$+'.~7>=~_^-`:````.............`-_7O777CO7O?HHHHOCCO00HH0BXXB000HHHHHHHH0~ ...
  .O_          >B0H0XXXBXXXBH%X0HOC+OHHOCCC7C7~+=7OBX+`^7_--_=+v~~?O:^7CH+-___+X#X=-`.=7+=~~=:::-`..`..``..`.....`-_~OO77CC7??HHH?OC7O00O?H0XBBHHHHHHH?HHHHH-.``
   7_         `?0HHBXXXXXBX%X%BH?OC7?HHCCCCCC7^v=+?7?$C=+---_=vv^+?~'vCH7____=BX7~-'`'+O>+~=_-^:__'''``'``````...`'-_>0O7OC7??HH??CC7?0HOCHHBB0HHHHHHH?HHHH?+`'-
   v^        '=00000000BXBXXX%BHOOCOHHOCCC77C>:~==?C:v$$?:'-_vv=^+='^C?+__^++CO+^_:~::7>=v++v7?H0BXBBB+--_'````..``'_^CHOC7C??H??OCC>HHHOCHHHB0HH??H??OOO7v~~:'`
   _v     '=CHB0H00HHHHBXXB?0XBOOCO?H?CCCC77C~:^=:OO:-:?%0-'_=v~~v-_7?~'__:^_^+v^_7v'_>7C>C$@@@@@@@@@@#~.''```'`````'_7COC7O??00HOC7>HH?OC???00??????C>=^__^+C^ 
   `+.  .v0B0BB00?????HXXXBHHHHOCC?HHO77C77C>::^~_O?^-.^=v>^_=v~=^_7O=-__:_``=>=-:=` ~HC=7#@@@@***@@@*@#^.```````````_7CC77O?HC==>O>CH?OCCO??HH???O7+~-'_~>C?H?^
    _' :OXH7?00?OO??OOHXXXHHHH?COO?H?7>CCC7C~:::^:C?=^-~^`-~_=v~=~>>:'___-``'+>__:-`~?C>B@@@*$$%%%$***@@%-.``````````:>O777O??:..`v7O??CC77???HO7+^_'':v>O?HHHH0
    .`=0XCvC0H?CO??OOO0%X77HHHOOOOHHO>7CCCC7=~=>>+O?::-~=~`'_++^>+~--:_-'```:7~-___^+CB@*#*$%%%%%%%%##*@@H`.`````````-+O7>C??O:__'`^C??CCC>OOC+~_''_~+CCO?HHHHHH
   . :BX+:HBHOCO???OO?XB~`C0H?CCOHH?>+C7OCC=~^^v$*#$7^^=^v=-=?v~=''_:_'````'>+---:v=>X@B7$$%%%%%%%%%$$O$@@O```````````~C>7O?HC~^~^-`_O?C77vv~_``''=CO?H?O?HHHHHH
    .O%C-?BHO7??OCO?HB7' `O0HOCO?H0C+7CCCC+::_~B@@#*@B=vv::^H?=~:'__'``````~7_---:-7@@O^O*%%XXX%XX%XX#>v#@*7-````...``~C>7O??C^:^~^'.~?C>=_`.`_--~7????H??HH0H00
    ~X?-CBHOCOOCCO?O7^   'O0?CC?H0H>>C7?C7~:_:X@*77#*@#O+=~>vvv=:_'``````._7:'_'-`_0@B~~X$BBBX%%%X7-^$C^>@@?'.'``....`+>+7O??=_::^~_`'+v_`.'^=_-=7O???HHH?HH0000
   `?B=>BHOCOCOO7=^'     '?0OC?H0BC+C7??C?^_vH@#>^0$%$*@$Ov^'~v=-```````.'v^'_''':X@X=-_$B00X$%%$B' ^%C'^H@@?-.``....->v>7O?7::::::~-'-``_~+7=_vC?????HHHH000000
   ^XO>B0?CO7O>:`        '??COH0%0+7770CHX=vC*@>_^X%XXX$*@?^-:v=````````-+_`_-'''C@$=- -$000$$%%%Xv=7XO `O*H%X:``....~+v>C??~:^:::::-``_=7>7v-+O????HHHH00000000
   7B7?0HOOCC=.          -OOO?0XBO+>+?HCX%+:7@0^.:X%XXBBX*@%v:v~``````':v:'_-''`_B@v:` :$HHH#$$$%$$>-B? .C0_`^:`... `>v+7O?C~==~~^-```-+CO7=-~C???HHHH000000000B
  `H?C00?CC7_         . `>OOH0BH0C++CBOHX?v:#@7- :XXXXXXHO**+_v^```'-:~~''_-''''>XH-_. :$?7?@#$$$#$>vBO `Ov``.``....^>~>7O?v^::::-.':_`>OCv'_>O???HH000000BB0000
  ^0O00?CC~`           _7??HB0H0H>+70BHX?^=H*#>` :XXB%%%v^$X>:v:`````'-''''''`'vv^^'_` -$O~+7=^C#*%+vB7 -C'`````..._>=v7O?+_:::-``-:~_`>O+--+CO???HHBX00000BB000
  +0H0H7C~            :???0BH??0Ov>HXHB%7->0v%O` :X00$$$XH%?=:v:```````'```'``:^.`-'-' .%H_.   _*@B~=X= :~.````...`+v^+7?O~^~~_`._::~-'77:`=CO???HHH0XX00000BB00
  CB0HO7=`           _?0H00HOOHH7vOXBHX%>_v~-7H' :XOO##$*H0O=`~:``````````````-````''-. 0B.    =@@C_+%^ ''`````...~>^^>OH7:^^~:`._::~'->~'^7OOHHHHHH0XXB00000B00
 `?X0HC=.`         `=H0OHHHHO?0?>>HB0XX%+:~~_:O~ _%7=+vX@%H?_'::`````````````````````'. +H     0@X^_?$- ```````. ->=_=C?C=::::_' -^^_`_v_-+OOO?HHHH00BXXB00000B0
 'HBH?=. .       -=O07^v?0?H??HO>C?0XXX%+:^=:_=v `?^  -%@BCO-'':'````````````````````'. '=    -?C=_v$7 ````````.`vv_^>?C^~^::::- '^_``^^_vCOOC?HHHH00BXXX00000BB
 _00HO`      .'~7?O+_ -OBXH?BHHCCH?BXXXX7::~^::^- ^` `B@*7C7`-`'_``````````````````````  ^~`.'-'``~%0`'```````..v>:_+C7~:^^::::- `_''_~:vCC?OCOHHH0000XXXB000B0B
 :00H~ .  .'^=++=:`   >BXXH?X0OC?HOHXXBX7:^~~:^^: `C=_+?>:B=.-``-_'```````````````````'` `0X+^-'-=XB_-'``````..=7~:+CC-:^::::::' `-'-::~7C7?OCOH0H0000XXXXB00BB0
 =B07.    ....       '?XXBH?XBCOH?CHXBBBC:=^~:::^' =$>'``+0'`''``''````````````````````'. 'H%H7C?%H^=='`````..^7~^>C>-`^~::::::' .--_-^>CO7??CO?0HH000XXXXXBBBB0
 >XC`               .>XXXBHHB+CH??C?BB00O^~:~~:^:_` :OH?H0:.`'````````````````````````````'-~+>7C7v+7=-````.`~>~~>7~'.^~^::::::` .'_--+COO7?HCOO00H000XXXXXXXXX0
 7B_                =BXXX0H07:HHCOO?00??Hv^^^~:^_'=' .vC>:```'````````````````````````````:v_'-:::^v^-`````'=>~=77_`.'~::^:::::` .-_'~7OOO7?0COOH0H00BXXXXXXXXXX
.O7              . -HBXX0HH0~~XHCOCO?HO?HC^^:=^:_'~~::''_:'````````````````````````````````''`''```'```..._++~+7v-`'`-^^==^:^^^` .-`:>COOO7H0COO?0HHHBXXXXXXXXXX
.7:               `O0XXBHHH0vvX07CCO7?O?HH~_~=^:_`.::=vv^-``````````````````````````````````````````....`^>+v+v_''''`_~=^:::^^_` .`-+COOOC700COOO00HHBXXXXXXXXXX
->.              '+H0%BHHHH?7>H0HC7C7CO?HB?^~~::_````'...```````````````````````......``````````''`.`-^=+7+~~^'''''``:^~::_--_-. `:v7COOO7CX0C?OOH0H0XXXX0XXXXXX
O=              :Cv?XX7?H??O~>O???+CC>OO00XC^=^^_`.`````````````````````````````...........`.```'_^=+>+v=^_-''''''``-^^::__-__-  ->CCCOO7+?%HC?OOHHH0XXXB0XBXXXX
?`            .vBvv0%?vHHO?C-+??7O>>?>OOH0BX=~~:_`...````````'_``````````````````.............````''--''''''''''''``::::______-  :COCOOC++B%HC?OOH0HBXXX0?BXXXXX
=   ..       .>X>`7XX:+0?O?7`v0O>77+?C>?0BBXC:~:_`..`````````-:'``````````````````.............```''``````'''''''``-:^^__-____- .~CCOO7+~CXX?OHOOHH0XXXXH7B%XXXX
.   .`      '70C.'?Xv.CH?C?7 ~?C>>C>7OCC0BBXB=~^_`.`````````-:_``````````````````````................``''''```'''`'_vBHO>^_-_v: '+COC>v~>XXBC?HOOH0BXXXB>+%XXXXX
     .     .7HH- _0H.`CH?CO7 ^OC>+>7>CC?HBBB%7^^_'.````````'::-````````````````````````......... `:~=+>>>>>+v~_'``_~B%%%%H+v77- :>C7+=~7%XXHCH?OO00XXXB?_C%XXXXX
     .     ^HHv  :X= 'O?O7O> ^CC>+>77CC?00XBX?~^_'`````````'_::```````````````````````````.....'^>>+v~~~^~=v+>>+~:~0$%%XXHOOO>-.~>>v~~77O0XO?HOCO0XXXXB=-0XXXXXB
          .7H?-  =0- 'O?77C+ ^CC>++>CCCH0?BXX0=^_'`.````````'_^'````````````````````````````.`~++~____::____^~vv+>C??H00OCC77+'`~v=~=>v'`~??H?COH0XX%%>.+BXXXXXB
          -?HC.  >O. 'C?>+C= :C7+vv+7C?0?OBXXXH=_-````````````-'````````````````````````````:+=^::^^^^^^^:^^::^~=++=v>>>>>+++=`'~~v+v^-~>O?HHOC0XXX%X+ ~HBXXXXBH
          _?Hv.. >C. `CO++C~ -77+vvv>CH0OO0XXX%+_-``.``````````````````````````````````````^7=:^^^^^^^^^^~~~~~~^~+>+vv+>>>>>+~`:+77+=vCHHH???O7=OX%H^ -?BXXXXXBv
          -?H:.. >C. `7O+v7: `>7>vv+>CHHCO0XXX%C_-`.``````````````````````````````````````^7=^~~~~~~~~~~~~===vvvv+>O7>++>>>++~`~>77COOOOOOOOOC:''~C_ .70XXXXXX>.
          .70^   +?` .>OvvC- `v7>++++OHOCOHXXX%?__`..````````````````````````````````````->+=v===vv===vvvvvv++++>>7??>>>+>>++^-=++++++++++>Cv_-_---^_v0BXXXXXO' 
           -H7 . ~H^ .vOv=>'  ~7>+++7H?COO?BXXXB^_`..````````````````````````````````````v>vv~^:^:^==~~v++>>>7CCCOH?O>>>CC>>+:_======vvv=~^:--------:=O%%X%0v'  
          . _C-  _?+  ~Cvv+.  _>7+v>OHCOOOOHXXX%v_'``.``````````````````````````````````^7^_--'''-_^>++>v=+>77COO?7>C>>CO7>v^'_~=vv===^:_--------------vBXO:    
          .` `_' -CC- _C+vv.  .v7++C?CCOOOO?BXX%C_-`..`````````````````````````````````_+_'---''-_-`~+vv+>>>>++v=~^77>COCv:--`-______------------------':v-     
           `. .` 'CC= '7>+~  . _7>7?OCCOOOOOHXX%0^-``.`````````````````````````````````=_`---'''--_-`=v=~^~~~^^^^^^+>>C?7'`''`''''---'-__-----------------^-. ..
           .`    `>C>- ~7+:  ...~7CCCCCOOO??OHXX%C_'``.```````````````````````````````':`-_'``'--'''---=+v=~~~^^:'._C>7OOv'``````''```'---_-----------------__--
            .  .  vC7= '>7_  .. _CC7CCCOOOOO??BX%0^-``.```````````````````````````````'-'_'```---''`:` .'_^^^_-'`...~777C?>^``'''`.```..``''-------------_:::--v
      .           _C7+' v7_  .. :C7CCCCOOO??O??BX%>-'``.`````````'-``'''``'''----'-:^'`'-_``.'--''''_.... .  `-__-'``-=+>>>=`_=^` .'``........'--__---_:~:`..`=+
    .'`         ...+7>~.'7: .. ->77CCCOOOOO??OO??XXv_'`.`````````'^^:::_'`_::^^^^^^^'```'-```'--''`_-.....``_:~~~~:_-`.`'_:_`-_'  .'```.........`''-::^_`....:vC
    ->.          `.-7>+~ ^^ . ^777CCCCCOOO?O?O?OCOX%+-'.`.`````````''''````````````.`````''``--''''_`....`-~~:_____==:-'. .`.```   `'``......... .'__'. ....-=70
    -C`          .. ~C++:':..^77>7CCCCOOOO?O???7C7C%Xv''`.`````````````'''''``````````````'`'-'''`'_....`-~^-------_=~~:-'`````'`  .'...........`--`........~=H0
    `C^           . `+>++^-`=7>>>77CCCOOO?OOO?O>CC~B$B~''`..``````````''-''''```````````````'''''`--..``'::-------_---_~:-'`````'. ``...........``........ '~7HH
     =?_        .    _7>++=>7>>77>v7CCOO0HO???7>CO'O%X0~-'`..``````````''''`````````````````'''''`_-`.`'_^--------__---_~_'`'`..'```....    .............. :vO?0
     `CH+'      .    .~77777>77>v=v>CCOHX0O??O>>OC.7%0BXC_'`..````````````````````````````.`''`'`-^'``''_---------------:^'`-'``'.'`....        ......... .^>?07
      ^H0O~`          :77>>777v~~~>CCCOBXH??O7>>H+ O%B?0$H_'`..```````````````````````````.``'''_::''``_-----------------^'`__--`.'`.....    .`   ....... `~CHO-
      .=??OCv:'````-:v>7>77+v==v~=CCCCHXXH?O7>>O?'_B%XHO?X0~'`..````````````````````````...`'`-::__`.`-:------------------'-___-..'_-'`..    `+v   ...... 'vOH^ 
     ...=C77CC7>>>7777>>++v==vv==>CCC?BXB?C7>>CO~'?%XX0OO?$%>:`..```````````````````````...`'_:_-'..``_:------------------__:^^_'``____--````.=?`         -+?O` 
      .. _>>++>>77>+vv==vvvv+v~v>77C?BBHC7>>>CHCC0XBBX0?OOX$$X+'...``````````````````````.`:=:_-` .'``^-'--------------__-_______`.'-___-'``.._H+'-'''``` -7?=  
          -v>++++vv==vv+++vvv~v7>77HB0O>>>>7CH??HH??????OOB%H$$?^``..`````````````````...'v>:--`  .'`'_--'--------------_--_^^_-_`  .`-__-``.  >H- ....`` -CC'  
        .  ._=+>++vvvvvv++v=~v7>>7HHO>>>>>CO????OOO??O??OOX%?X%$$7-...````````````.``..`:CC_-_-.   `'-_------------------_---_~:--    .`'--'`. ^7`        '7+   
              -^^^v>++vvvv==+>>>7C7++>+v+CO???OOOOO????C>O%XOX%%BXC^-...``````````...'^+?O_--_-.   ..`-------'----------__----_~^_.      .-:_'``. -` .    .>= . 
          . .   '=CO7+vv==+>7>77+vv+=_``v???O7CO??????7+CH$0OB$H:vCOCv'..````````..'~7OOC^-_--_'      `----''----_--_---__-----:^^_      .-^~_--` _>_`     v^   
          .  .:+7C>+++vv>>>>7C+=v+v-. '>??O7CO??????C7>COH%HOB#>:7C7CO7~`.`````..'~C?OCO=--___-`      .----''-------__-----------_:`     ._:^=:-_-.== .    _=   
       ..  `_+C>+vv++v>77777>v=++:.  'CH?C>CCCCCOCC77>7??X%O?X$v:CC>=>OO>^`...`_vv:>OCOv------`       '----'------_---_---_-------_-.    `-_:^=~_--``.     .^.  
         `:+7>++++>>>>>>>7>v=vv~' . '>?O7>7777777CCC+v7HO0HO?X$=:C7C=:v7CO+^_:vCO>-~CO+-__--''.     .`---'-'''--------''.':------___'    .-__^~=~_--'`      `'  
       `^+>>+++>7>>>>>>77v=v+='  . `7O7>+v==vvv+vv~-_7H>-_>O?%%=^CC7C=-:=>OOCCOCC7--7>___-`.`-`   .``--'-'--'''----'``.. `^-----_____. `'.'^:_:::^:-_-..  ..`'``
   .  _+>>+++>77>>>>>>7>v=v+~` ... ~Ov_`..   . ..  :CHv. '7OH%$v~C77CC:-_:v7CCCCC7:~v_--'`.`'--`..''`'-```````-_-'``......~_---_~:___..-_-.``'-:::~:-~^'''''````
   . _>>++>7777>>77>77>==v+~..... `>^.          .->HO^   :??XX?~+C777C~____:=777>+~^-'`...`'-:_--``..`^....`''--'.....  . ~:-_--v~:__` -:~`   `'_:_~:vv-'`......
   '~7>>>>C+v++>77>7>>v=v+v`..... -^  .      .`-^+v:..'''+OH$O-_77777C>_____^^::--''``...`--::`-'`...`^```''---`.....     ^_----+=^:^-.'__-. .  .'--:v>--'```...
. ->C>>77C~:++>77>77>v=vv+_ ......``      .`-`.``..'-__--__:==-vC>v>77C=_:-~_``````.  ..`-_^_`'`'`...':''--'''`... .      __---_7+=~^_`.____`  .`. .`_=_-----'''
 `>7>>7C7^-+>>77>>7>+=vv+v' ..........   . -^:- `-_-''`````..'^77=_>7777___~_``````   .`-_^_`'``'````'--''`.````'`...     -:--'~O7+v^:'.____-.  `_'`..`--__-_-__
.v7>>7C>-`+>>>77>7>>vvvv+v'............... `^_^~:-'`''''''''``=+~__v777C~-_~_`````.  ..'-:-.`'.--`'''--``...``'''````..   '~'-'+OC>+==-.-____-   '__-'``'-------
=C>777=` ~>>>>7>77>>vvvvv+:.................-::_`'----_'`'''''--___^7777>__~_'````  ...-_:`''`.-'`'''''....''''-'`''```.  .=''^O?C7>>+_.':____`  `_____:~^^^:^=>
C777C=. ^7>>>777v+7+=vvvvv='.`..`...........`___:^::::_''''''''`.`__>7>77^-~:-````. ..`-_:'`. ..`''`.''  .`'''''-''''''`. .~'-7HOCC77+~``__:___`  -_____+CCCCOOO
777Cv. ->>>>>7Cv`=7+vvvvv=v~`````'``''````````'''-_::-'''''''`.  .__v7>77v-~:-`````...`---`.  .`--...''..`''-''----'-'''`.`^->?OCCC77>v-._^___--' .-___-:>OOOOCC
7CC+`  =>>>>7Cv. ^7>+vvvv==:.`````..```````````'````_-'-'''`. `-'.-_v>>>7+-^:'`````````'''_'`````_`. ``.'''''-'''--''''''._v7?OOCCCC77+:.::____-_` .-__--~>OOOOO
CC>'  ->>>>7Cv` .'+>+vvv==^`                   ..````````.   `-__''^>>>>>>_:^'``````````'_-:'``..``. `'.'''''_:~~^^^^_''``+H?OOOCCCC77>=`'_____-''  .-____^+OCOO
CC_  .v7>>7C^. .. _>>+v==~`                                 .''__-'=>>>777:_:'-__:::__'``--:-.........^-`'_^~~~~~^^~==v~:-C?OOOOOCCC77>v-.______'-`  .-::_::>OOO
C>`  .+C>7C:     ..'~++v=-           .........```'``''''`. `___^^::>O???+_--''---'-__^:_---__ ...   . '~-~=^:^~===v+~=>++CH?OOOOOCCC777+_.-_____-''.  ._:::::>OO
Cv   '>77C^..    ....'_^_.         .`''''''`'``-_''--''-_-'^7???H>~CH?Cv^`''``..````''_::__-_..     .. ^+~^======v77++>v++CH?OOOOOCCCC7>-.-______-''   `_^::_vOO
C=   _77O+   .  .......`.     .`````'''``....`'-`'___-```'_=77CCOC^==^___'-_-'`````'``'--:_-~'      .'^v~=v^^~~^v+^^=>+~vv~>C??OOOOCCCC+-`'_______-'`   `_^^:+OO
Cv   ^CC7`   ........``.     .``````````.....`-''_____''--_=v=v+O='-`````'`'`.```````-__-':CH^      _=++>+^^~=v=+=~^:=^_~v7+v>??OOOCC7Ov-'`_____-__-'.   `-^^>OC
C>`  ~O7' .   .......``  . .`'`..............-'`______-__-^v=v+C=-'```...``'`...```'-__-'=HBB>.    _v+>7+~==v>+C>v+>>7+=:^~v^_=?OOOCCCO=--`-_____--__`   .`:~7CO
CC~ -CC-   . .......``.   .`'`.......... ...--`-________-_=vvvCv'``... ..````...``'___'_>H0HB?` .._vvv>+==>777>v:^^_v>>7>v^:^_'vHOOOCCO=__`-_____-_-_-.   .'=7OO
CCC=+C:     ``.....```   .``......  .     .^^`-_________-_=vv77'.........```'..``'__--~O000H?H^  -+v~~vv+7>=^:=+=:_^~^^~=+=^-:'->?OOCCO~::.-______-__-`    .:>C>
-vCOCC^'''_:_`.....`..  ``.......   .    .>>``__________-:+++0>''____------`'-'`-_---+HH00H7v?0: =+=~~+>C~--::>v7+_~^^:::^v^:--.-O?OOCO=~_`'______---''.    .~>>
  =C7C7>+v^'`.....``.  ```.....     .   _CH-.'_________-_v+=?B+:^:::^~^:__-`'_-'`'-:CHO?007+=>0H++~=_v>>^-_^_=v^v>v_:vCOCv-~^:_:`v?OOOO>__''______--'.``     'v>
 `>CC^ ..   ......`...``........    .`^700=.`-_______-_^v+=7X?_-__-_^^:^^^_``-'-''=O?77HBOv+v+?B0v>_^+>:':^''=_+~^+=CC>C77v-^::^__OOC?C^-_-'_-__---''.`'.     :+
 :C7C-   .......```..``...... . .`'_^vC7+=-.`_______-:=++v7BH^-__-:^_---_::-`^vv++>>v>HBC^:=v>H07v~_v>^~++=^^===~+7>+=vCC+7v-~::^-COO>:-___'-_----'....``     `^
.=C7C: .........``..``......      .`'`...:`.'______-^++vv+HB~---_^~_-_-_--+~`>?O7+v=+HBC__:_=>00v^_~>=+O7v~~v+v~~+^=v+O?v~v7^-^:^:>H>_-____--_-_--'....`'      `
 =C7Cv..`......``..``.......            --``-_____-:+vvv=CX>-__~^^^___---~O='vvv=v=vHBC_-^__=7BH=^_=>=C>+=~~~~^^^~:>>>+^:v++v-^::_~7_-__-__---_---'`....'.      
 :CCC7-`'`....``.```.........          ._```-_____-=+vvv+B?---~:''_--__-:O?='~=vv~~OBH:'_^-_v7B?~:_v+7>>>>v=+v~~`:_+>v=::^=>>'~:::~_-____---------``....'.      
..^CC7_```...``.```..........          '-```_____-_vvvv+H0:.`--.`_`.``'_C0C^_=~^::OBO^--:--_=CBC^_:>=7+~=+=^++_~'__:vv:-:^v7=`^~~v:-_-__--''''''''``....``      
.. -=^'_'...``.```.........           ._```'_____-:+vvvOX+..._'`^-....`>BHv^::_-_CBO_''-_''_=7B7:'^v~7>^''_^^^^:___>Ov_` -7C='_=>^-_--__--'''''`. .``...``    .'
...`''_=+_.``````...... ..          `:~_```'_____-:++v7B?-..._>>-.....~007:___-_7BO_''`_'''-~7X7_'==^7v':~^^~>=-:^:~v=vv^=~^7^'+v'----___--'''`..  .``..`'    '^
..`'''''_^_````........  .. .       ^^^'``.-_____-:+vvHB~..` 'C~ ....-OBC:___-_CX?:`'`--```'^>B+_`v^_>=:~ .-==:::~~v+~_::v_+Hv:v----__------'`...    ...`'    -~
.`'```````''`'`... ....  . ...      ^_-````_______vvvOB7'''`'^-....`'+BC:___-^OBC~'```-`````:+B+-`v~':v~~'_~-^=~_^:C^::~=_^7H+=:---------'-''`.     . ..''.  `~v
........``'``.................      ^_'```'____--~>70X>_--``_` ....'vBC_-__-~HX>_-'`.`'....._v0>-`v~'-^-=~_-=^-v--^=  ._7~7>O7:'--_----''''''`..     .``''  .:++
.. ......```..... ... .........     ^:````-____-_+?X0v'``..`......`~BH:-__-v0B+-_:'``-'...''-=B7-`v='_>---_~-. ~~'=v` `v^=>HO>_---___----'`'`. .   ..``''-  -=>+
.... ............  .   .     ..    .~_````-___--=0B7_`............^HBv-__-+B0>_:^:-'`__`-^~^^v0?_`v=-_C+--=^   ^v~~==-~~=>>7Cv-----------'.'`..  ...`'_-^: .^+>>
....      .......       ..  .. . . -^:````__-_^+B0~`..`'`.''`....:H0v-___7B?=:^~~:-''''^^_---:+H^->+__v+v:^^^_:=^_:^=v==~`+7C_-----_-----`.'... ..._v>7:~- '=>>>
.         ..  .       .  . .   ..`_^:^```'___vv?X>...'_':_'`.`.._?0=-_-:OBC::~~~=:-`'.`_:-___-'=7^>>__v7>vv=^v~^~^__^~:7vv?O+'---'-------.`'` ... _H??C:^`._+>>>
          . ....      ...`____^~v+=_:~'.`-_-=7vH0:..'-`_:'....`:O0=-_-^OBC^^~~===_`-`.``_--___-'=+>7-_'=v=-~+~~~:_::=~^>>>7O^----''''---`.'`.... .>HO?+_-..^+>>>
             .    .   ..`:vvvvv++=___^-``-__>v+BO'.`-.-_. .`'-vHH+-_-:O0C~^~~===~-`-..-`'----_---:>O^-'=~v^:77~=v=:^=v==>7+7-__---''''-' .`..... _??OO~```'=+>>>
                      .._=vvvv+=:____:-`'_-+7=OBC..`_'-.`:=vv>OC~___=?H+^^~====~_`'`  '''-.'--__--_vC--:+>77>7v=v~v+7>+?7vH7--__--''''`  .`.....`7?OOO:.``_+>>>>
     .-.~>.      ...   '~+vvv+~--____:_`'_~O+v?Xv ..v+`->?>:____-__~OOv^~~==~=~^-`'.  ._`'.`--_--_-'vv-_OC>+>>7CC>==O0>BOv0v--------'`   .'.....~HOO?C-.``-+>>77
     7+ ^O.      ......:vvvvv^--_____::`-_>Ov+HB_.`:='^O0C:'-'''''-:~^:^~~==~^~:```    -''`.'_-___---v^:O>OO7?O+H>~~~~^^^:^^--'--_-`.    ````..'O?OO?>'```'+7>77
    ~B- '=.     ..... `^vv+=:-'-_-__-==`'^C7v+0O``''`=00O=--___---_-'''-_:^~^-:-`'`..  .-'` .'-------_+:7O0X>O7~_---''''-''_-_'```.      .`..`.v?OOO?=`''.`>7777
.. :0+  .`..:.    ... '=v+~_''`-___-^7>-^7C+=vB~..'=OBC=:_--____=C>~:::__----'```'`.. . `_-. `-''-----=+^0O+=:-'--'------''''-_`         .``..:OO?O?O_..`..v7777
.. =+.    'vO_    ..  _++^-'``'-___-v>>~>OCv^70' _OBH+_-__-____=?H+~====~^^:_-. .'`..  ..-'. .`'''-----C>v_'--_--''-'--'-'''''_` `'``'``. ``.`>?>v7Cv`   ..~C777
:v-      .>OC:     . .^+^-````'--_-_++>>>O>v:?7'>B0>:_____-__:v?HC========~~^_` `'`..  ..`'...``''----_v^'--_---'''-''--'''`''-` ''```~0'HH'._O+_-__-` H+  ^C777
77'       :7>' . .....~~'`````'----:++++7O+=~07?BO~-___-___~>OH?O=========~^:''``'`....  `_``...''----^_'------'`''`''''''````'`.``=@@@@@0.`-7+--__'`.   ..^C7CC
>v'        :v.    .. `:''`````'----~+++>>7=~+00C~______~~_^>?O7+========~^_-`.'-.'`....  .__`.  `'---------'-'-'``.....`......'`.'....=@.'`'?7-^+_>v.=- :..~C7>=
>=_.       .-   ....`:'```````'_-`'=+++v>>=^O0=--__-_=7>^-:vv==~=====~^:_-'`..''..`.......'~'`  ..'-'''''-'''''...    ..  ....```'....=@`'`'@>->@-@O.@=.H.`=~^_-
^'.        .  ':^.  -_`'``````'-``_v++v~>+~:>~-__-_=OH7^'_^~~====~~^:_'''`....`'` `'`.....`_:..   `''''`''`````..      . .....``'`....=@`':`@>_@>-@=@@v.H.:^---_
 ..        ...::' '=:-````````--``:v++=~Cv:____-:~C0?>^-_^~==~~^^:_--''``....``'`  ```.. .``^'..  .````..`...`.        .......``'`....v@-~~`v@>@>'@C@@v.0_^_--__
 ..              ->O=-```````'__``:++~~=C^-____=CHH>^_-_^~~^^:__--'''````....```'.  .`''````':`.. ..         ..        .......'```....v@+~_`-%@@+`@@=@v~%:------
                -vCC=-```````'-_'`^+=~~+7_---:>H0C^_--_^^::___----''````````````'`.   .`''`'`_-.. ..         ..     .........`'`'`...`v@^-_-.'_@v`@@`>@7X:^:_---
              . :v=:_-```````'-_'`~=~=^v7_-_=C?Cv___-_::____-----'''''''``````''-''`   . ..`''_``.`.           ...........`'`'''`..`70BB0BB'.`'H^``_+~=:^.'-:::_
             ..`_---_-```````'__'-=~~^-v7_^>O7=_-__--_______----''''`'``'`'--''''`..   ..`..'`:_``.        .....```````'''''-''-'````-^____-..'`..`=7:-_:    .'_
              .`.'_--_'``````--_-^~:___>7>C>~:-___'`''-____---'''''''`^=_-'`.... .   .```''.`'':-`` ......````````'''''''`.````''-_:::____-'..'`.`~7^-_^'  ..   
             ...._---_'``````---^~_---_>CC=_--___'...``---'-----'`'+7>>=:'.    .... .'``````..'-~'``.``````````''''''`........```-_:_____-`'. `'`:Cv--:_ . ... .
 * 20200521:第一版
 * 20200602:完善批处理
 * 20200603:新增首选项设置
 * 20200604:新增拾色器、图片移动
 * 20200605:新增"最近打开过的文件"
 */
using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Linq;
using System.Collections;
using System.Text;
using System.Threading.Tasks;
using System.Windows.Forms;
using System.Windows.Forms.DataVisualization.Charting;
using System.IO;
using MaterialSkin;
using MaterialSkin.Animations;
using MaterialSkin.Controls;
using static Gmage.RollBack;
using static Gmage.ImageProcess;
using System.Threading;
namespace Gmage
{
    public partial class MainForm : MaterialForm
    {
       
        /// <summary>
        /// 消息处理
        /// </summary>
        /// <param name="e"></param>
        private void MessageManage(MessageEventArgs e)
        {
            switch (e.messageType)
            {
                case MessageType.ImageReading:
                    mPB_Bar.Visible = true;
                    Thread thread = new Thread(new ParameterizedThreadStart(SetImageShow));
                    thread.Start(e.FileNames);
                    break;
                case MessageType.RunTime:
                    break;
                case MessageType.Message:
                    SetImage_Control(e.Message);
                    break;
                case MessageType.Error:
                    break;
                case MessageType.DeadlyError:
                    MessageBox.Show(e.Message, "致命错误", MessageBoxButtons.OK, MessageBoxIcon.Error);
                    break;
                case MessageType.Progress:
                    if ((int)e.Progress < 100)
                    {
                        mPB_Bar.Value = (int)e.Progress;
                    }
                    else
                        mPB_Bar.Visible = false;
                    break;
                case MessageType.History:
                    AddHistoryItems(e.Message);
                    break;
            }
        }

        private void SubthreadMessageReceive(MessageEventArgs e)
        {
            try
            {
                if (this.IsHandleCreated && !this.IsDisposed)
                {
                    MessageEventHandler handler = new MessageEventHandler(MessageManage);
                    this.Invoke(handler, new object[] { e });
                }
            }
            catch (Exception)
            {
                //throw new Exception("", ex);
            }
        }
        #region 变量
        public Tools Tool{set; get;} = Tools.Empty;
        private Tools lastTool= Tools.Empty;
        private bool spaceUp = false;
        ToolTip toolTip = new ToolTip();
        int history_Count = 10;
        int history_Name_index = 1;
        public Bitmap ResultImage
        {
            set => col.Image = value; get => (Bitmap)col.Image;
        }

        public Bitmap initBitmap { set; get; }

        private Hashtable htTabImageName = new Hashtable();

        bool canDrag = false;

        //Bitmap 

        #endregion
        private readonly MaterialSkinManager materialSkinManager;
        public MainForm()
        {
            InitializeComponent();
            initBitmap = new Bitmap(1, 1);
            ResultImage = initBitmap.Clone() as Bitmap;
            materialSkinManager = MaterialSkinManager.Instance;
            materialSkinManager.AddFormToManage(this);
            materialSkinManager.Theme = MaterialSkinManager.Themes.DARK;
            materialSkinManager.ColorScheme =
                new ColorScheme(Primary.BlueGrey800, Primary.BlueGrey900,
                Primary.BlueGrey500, Accent.LightBlue200, TextShade.WHITE);
            menuStrip1.BackColor = ((int)Primary.BlueGrey900).ToColor();

            if(Config.WindowStateMax)
                WindowState = FormWindowState.Maximized;
            else
                WindowState = FormWindowState.Normal;

            //Mtb_Color
            tabPage1.BackColor = Color.FromArgb(255, 51, 51, 51);
            //groupBox1.BackColor = ((int)Primary.BlueGrey800).ToColor();
            tB_R.BackColor = Color.FromArgb(255, 51, 51, 51);
            tB_G.BackColor = Color.FromArgb(255, 51, 51, 51);
            tB_B.BackColor = Color.FromArgb(255, 51, 51, 51);

            SetColorRGB();
            // pTools.BackColor = Color.FromArgb(255, 55, 71, 79);
            messageClass.OnMessageSend += new MessageEventHandler(SubthreadMessageReceive);
            TsmiClick();
            TsmiThresholdClick();
            ToolsClickEvent();
            SetToolTipPromot();
            this.KeyDown += (sender, e) =>
            {
                if (e.KeyCode == Keys.Space)//空格键按下可移动图片，仿PS
                {
                    if (spaceUp)
                    {
                        lastTool = Tool;
                        spaceUp = false;
                        Tool = Tools.Move;
                    }
                }
            };
            this.KeyUp += (sender, e) =>
            {
                if (e.KeyCode == Keys.Space)
                {
                    Tool = lastTool;
                    spaceUp = true ;
                }
            };
            LoadHistory();
        }

        /// <summary>
        /// 设置按钮的提示文本
        /// </summary>
        private void SetToolTipPromot()
        {
            toolTip.SetToolTip(mFB_Cut, "裁剪");
            toolTip.SetToolTip(mFB_ColorPicker, "拾色器");
        }

        #region mtS_Selected及以上的控件功能
        private void btn_SelectImage_Click(object sender, EventArgs e)
        {
            ReadInitImage();
        }

        private void ReadInitImage()
        {
            OpenFileDialog oi = new OpenFileDialog
            {
                Filter = "图片(*.jpg,*.jpeg,*.bmp,*.png) | *.jpg;*.jpeg;*.bmp;*.png| 所有文件(*.*) | *.*",
                RestoreDirectory = true,
                FilterIndex = 1,
                Multiselect = true,
            };
            if (oi.ShowDialog() == DialogResult.OK)
            {
                RollBackMessage(oi.FileNames);
            }
        }

        private void SetImageShow(object fileNames)
        {
            var files = (string[])fileNames;
            var count = files.Count();
            float c = 0;
            foreach (var filename in files)
            {
                RollBackMessage(++c / count * 100f);
                SetImageShow(filename);
                RollBackMessage(filename, MessageType.History);
            }
            CheckonIndex();
        }

        private void SetImageShow(string filename)
        {
            var Format = new string[] { ".jpg", ".bmp", ".jpeg", ".png" };
            if (Format.Contains(Path.GetExtension(filename).ToLower()))
            {
                try
                {
                    RollBackMessage(filename);
                }
                catch (Exception ex)
                {
                    MessageBox.Show("不正确的格式", "错误的预期", MessageBoxButtons.OK, MessageBoxIcon.Error);
                }
            }
        }

        private void SetImage_Control(string filename)
        {
            try
            {
                var initImage = (Bitmap)Image.FromFile(filename);
                //ResultImage = initImage.Clone() as Bitmap; //严重的BUG 
                initBitmap = initImage.Clone() as Bitmap;
                if (mtS_Selected.BaseTabControl != mTC_ImageTab)
                {
                    mtS_Selected.BaseTabControl = mTC_ImageTab;
                    mTC_ImageTab.Visible = true;
                    panel1.Visible = false;
                }
                SetTab(Path.GetFileNameWithoutExtension(filename));
                if (!HideTab())
                {
                    materialContextMenuStrip1.Enabled = true;
                    tsm_CloseTabPage.Enabled = true;
                }
                else
                {
                    ResetBitmap();
                }
            }
            catch
            {
                MessageBox.Show("图片打开失败", "错误的预期", MessageBoxButtons.OK, MessageBoxIcon.Error);
            };
        }

        /// <summary>
        /// 打开文件时tabcontrol显示图片名字
        /// </summary>
        private void SetTab(string imageName)
        {
            imageName = reName(imageName);
            AddPagesIndex(imageName);
            TabPage t = new TabPage(imageName)
            {
                Name = "tp_" + imageName
            };
            mTC_ImageTab.TabPages.Add(t);
            PictureBox it = new PictureBox()
            {
                Name = "pb_" + imageName,
            };
            var tp = mTC_ImageTab.TabPages[t.Name];
            tp.Controls.Add(it);
            tp.BackColor = Color.FromArgb(255, 51, 51, 51);
            htTabImageName.Add(t.Name, it.Name);
            mTC_ImageTab.SelectedTab = tp;
            it.Dock = DockStyle.None;
            it.SizeMode = PictureBoxSizeMode.CenterImage;
            it.Image = initBitmap.Clone() as Image;
            it.Width = it.Image.Width;
            it.Height = it.Image.Height;
            var p = GetControlCenterLocation(tp, it);
            it.Location = p;
            it.Anchor = AnchorStyles.Left|AnchorStyles.Top;
            Point mouse_offset= new Point();

            it.MouseDown += (sender, e) =>
            {
                switch (Tool)
                {
                    default:
                    case Tools.Empty:
                        break;
                    case Tools.Move:
                        canDrag = true;
                        mouse_offset.X = -e.X;
                        mouse_offset.Y = -e.Y;
                        break;
                    case Tools.RGB_Pick:
                        var c = ((Bitmap)it.Image).GetPixel(e.X,e.Y);
                        Pick_RGB(c);
                        break;
                }
            };
            it.MouseMove += (sender, e) =>
            {
                it.Cursor = MouseCursor();
                switch (Tool)
                {
                    default:
                    case Tools.Empty:
                        break;
                    case Tools.Move:
                        if (e.Button == MouseButtons.Left&&canDrag)
                        {
                            it.Location =new Point(it.Left + e.X+ mouse_offset.X, it.Top + e.Y+ mouse_offset.Y);
                        }
                        break;
                    case Tools.RGB_Pick:
                        if (e.Button == MouseButtons.Left)
                        {
                            if (e.X > 0 && e.Y > 0&& e.X< it.Image.Width&&e.Y< it.Image.Height)
                            {
                                var c = ((Bitmap)it.Image).GetPixel(e.X, e.Y);
                                Pick_RGB(c);
                            }
                        }
                        break;
                }
            };
            it.MouseUp += (sender, e) =>
            {
                switch (Tool)
                {
                    case Tools.Move:
                        if (e.Button == MouseButtons.Left)
                        {
                            canDrag = false;
                        }
                        break;
                }
            };
        }
        /// <summary>
        /// 获取[里控件]居中于[外控件]时的左上角坐标
        /// </summary>
        /// <param name="outC"></param>
        /// <param name="inC"></param>
        /// <returns></returns>
        private Point GetControlCenterLocation(Control outC,Control inC)
        {
            var x = 0;
            var y = 0;

            var outW = outC.Width;
            var outH = outC.Height;

            var inW = inC.Width;
            var inH = inC.Height;

            x = (outW - inW) / 2;
            y = (outH - inH) / 2;

            x = x > 0 ? x : 0;
            y = y > 0 ? y : 0;

            return new Point(x, y);
        }

        HashSet<string> NameHash = new HashSet<string>();
        private string reName(string name)
        {
            string extension = Path.GetExtension(name);//扩展名
            string fileNameWithoutExtension = Path.GetFileNameWithoutExtension(name);// 没有扩展名的文件名
            if (!NameHash.Add(name))
            {
                return reName(fileNameWithoutExtension, fileNameWithoutExtension, extension, name);
            }
            return name;
        }

        /// <summary>
        /// 重命名
        /// </summary>
        /// <param name="fileNameWithoutExtension">无拓展名的文件名</param>
        /// <param name="original">原始无拓展名的文件名</param>
        /// <param name="extension">拓展名</param>
        /// <param name="name">有拓展名的文件名</param>
        /// <param name="serialNum">序号</param>
        /// <returns></returns>
        private string reName(string fileNameWithoutExtension, string original, string extension, string name, int serialNum = 1)
        {
            name = original + $"({serialNum.ToString()})" + extension;
            serialNum++;
            if (!NameHash.Add(name))
                return reName(fileNameWithoutExtension, original, extension, name, serialNum);
            return name;
        }
        Queue<string> history = new Queue<string>();
        private void SetHistory()
        {
            int index =1;
            history.Clear();
            HashSet<string> hs_history = new HashSet<string>();
            for (int j = 0; j < tsmi_History.DropDownItems.Count; j++)
            {
                SetHistory("history", $"history{index++}", tsmi_History.DropDownItems[j].Tag.ToString());
            }
        }

        private void LoadHistory()
        {
            for(int i = history_Count-1; i>0; i--)
            {
                var h = LoadHistory("history", $"history{i}", null);
                if (!string.IsNullOrEmpty(h))
                {
                    history.Enqueue(h);
                    AddHistoryItems(i, h);
                }
            }
        }

        /// <summary>
        /// 打开图片信息添加到最近打开
        /// </summary>
        private void AddHistoryItems(string filename)
        {
            AddHistoryItems(history_Count+history_Name_index, filename);
            history_Name_index++;//防止控件重名
            history.Enqueue(filename);//最近打开，最多history_Count项
            if (history.Count > history_Count)
                history.Dequeue();
        }
        private void AddHistoryItems(int i,string h)
        {
            ToolStripMenuItem items = new ToolStripMenuItem()
            {
                Name = $"tsmi_history{i}",
                Text = $"{h}",
                Tag = h,
            };
            items.Click += (sender, e) =>
            {
                tsmi_History.DropDownItems.Remove(items);//点击后当前item提前到第一行
               // tsmi_History.DropDownItems.Insert(0, items);
                string[] file = new string[] { (string)items.Tag };
                RollBackMessage(file);
                
                //for (int j = 0; j < tsmi_History.DropDownItems.Count; j++)
                //{
                //    tsmi_History.DropDownItems[j].Text = $"{j + 1} {tsmi_History.DropDownItems[j].Tag.ToString()}";
                //}
            };
            tsmi_History.DropDownItems.Insert(0, items);
            HashSet<string> hs_history = new HashSet<string>();
            for (int j = 0; j < tsmi_History.DropDownItems.Count; j++)//清除相同的记录,时间复杂度N2
            {
                if (!hs_history.Add(tsmi_History.DropDownItems[j].Tag.ToString()))
                {
                    tsmi_History.DropDownItems.RemoveAt(j);
                    j = -1;
                    hs_history.Clear();
                }
            }
            for (int j = 0; j < tsmi_History.DropDownItems.Count; j++)
            {
                tsmi_History.DropDownItems[j].Text = $"{j + 1} {tsmi_History.DropDownItems[j].Tag.ToString()}";
            }
        }

        private void SetHistory(string val1, string val2, string val3)
        {
            GmageConfigXML.XmlHandle.SaveControlValue("MainForm", val1, val2, val3);
        }

        private string LoadHistory(string val1, string val2, string val3)
        {
           return GmageConfigXML.XmlHandle.LoadPreferences(val1, val2, val3, "MainForm");
        }


        private void btn_Histogram_Click(object sender, EventArgs e)
        {
            Histogramcs hs = new Histogramcs(ResultImage);
            hs.ShowDialog();
        }

        private void btn_Salt_Click(object sender, EventArgs e)
        {
            Config.Model = FunctionType.Salt;
            Probability py = new Probability(this, MousePosition)
            {
                InitBitmap = ResultImage,
            };
            SetImageCallback(SaltNoise(ResultImage));
            py.ShowDialog();
        }

        public void SetImageCallback(Bitmap bitmap)
        {
            ResultImage = bitmap;
        }

        private void button2_Click(object sender, EventArgs e)
        {
            GmageConfigXML.XmlHandle.SetPreferences("Conventional", "HomePage", "1");
            Config.homePage = 1;
            Config.bReStart = true;
            Application.Exit();
        }

        private void btn_FaceRecognition_Click(object sender, EventArgs e)
        {
            Config.Model = FunctionType.FaceRecognition;
            if (Path.GetExtension(Config.ClassifierPath) == ".xml")
                ResultImage = Recognite_Face(ResultImage, Config.ClassifierPath);
            else
                MessageBox.Show("请先选择分类器", "", MessageBoxButtons.OK, MessageBoxIcon.Warning);
        }

        private void MainForm_Load(object sender, EventArgs e)
        {
            if (Program.MyArgs.Length > 0)
            {
                RollBackMessage(Program.MyArgs);
            }
            Classifier_Load();
            Change_pB_Color();
        }

        /// <summary>
        /// 
        /// </summary>
        private void Classifier_Load()
        {
            var path = Application.StartupPath + @"\Classifier\";
            config.FloderExist(path);
            DirectoryInfo dir = new DirectoryInfo(path);
            FileInfo[] fi = dir.GetFiles();
            if (fi.Length == 0)
                return;
            foreach (var f in fi)
            {
                if (f.Extension != ".xml")
                    continue;
                ToolStripMenuItem items = new ToolStripMenuItem()
                {
                    Name = f.Name,
                    Text = f.Name,
                    Tag = f.FullName,
                    CheckOnClick = true,
                };
                items.Click += tsmi_Classifier_Click;
                tsmi_Classifier.DropDownItems.Add(items);
            }
        }

        private void AddPagesIndex(string ImageName)
        {
            ToolStripMenuItem items = new ToolStripMenuItem()
            {
                Name = "tsmi_" + ImageName,
                Text = ImageName,
                Tag = "tp_" + ImageName,
                CheckOnClick = true,
            };
            items.Click += tsmi_Index_Click;
            tsmi_Index.DropDownItems.Add(items);
        }

        Config config = new Config();
        private void tsmi_Classifier_Click(object sender, EventArgs e)
        {
            Config.ClassifierPath = (string)((ToolStripMenuItem)sender).Name;
            config.IsCheckedControl((ToolStripMenuItem)sender, tsmi_Classifier);
        }

        private void tsmi_Index_Click(object sender, EventArgs e)
        {
            Config.ClassifierPath = ((ToolStripMenuItem)sender).Name;
            config.IsCheckedControl((ToolStripMenuItem)sender, tsmi_Index);
            mTC_ImageTab.SelectedTab = mTC_ImageTab.TabPages[((ToolStripMenuItem)sender).Tag.ToString()];
        }

        private void CheckonIndex()
        {
            int i = 0;
            foreach (ToolStripMenuItem item in tsmi_Index.DropDownItems)
            {
                if (i++ < tsmi_Index.DropDownItems.Count - 1)
                    continue;
                item.Checked = true; //设选中状态为true
            }
        }

        private void btn_Save_Click(object sender, EventArgs e)
        {
            SaveFileDialog sfd = new SaveFileDialog
            {
                Filter = "JPEG (*.jpg,*.jpeg) | *.jpg;*.jpeg",//设置文件类型
                FileName = Guid.NewGuid().ToString(),//设置默认文件名
                AddExtension = true//设置自动在文件名中添加扩展名
            };
            if (sfd.ShowDialog() == DialogResult.OK)
            {
                try
                {
                    ResultImage.Save(sfd.FileName, System.Drawing.Imaging.ImageFormat.Jpeg);
                    MessageBox.Show("保存成功");
                }
                catch { };
            }
        }

        private void Open_Threshold_Config(int hold = 128)
        {
            Process.Threshold ptd = new Process.Threshold(this, MousePosition, hold)
            {
                InitBitmap = ResultImage.Clone() as Bitmap,
            };
            ptd.ShowDialog();
        }

        private void tsmi_About_Click(object sender, EventArgs e)
        {
            //Clipboard.SetText("Iyui.Github.com");
        }

        PictureBox col = new PictureBox();
        private void materialTabSelector1_TabIndexChanged(object sender, EventArgs e)
        {
            ResetBitmap();
        }

        private void ResetBitmap()
        {
            if (mTC_ImageTab.SelectedTab is null)
                return;
            var TabName = mTC_ImageTab.SelectedTab.Name;
            var selectedTabName = (string)htTabImageName[TabName];

            config.IsCheckedControl(tsmi_Index, TabName);
            col = (PictureBox)mTC_ImageTab.SelectedTab.Controls.Find(selectedTabName, true)[0];
            if (!(col.Image is null))
                initBitmap = (Bitmap)col.Image;
        }

        private void tsm_CloseTabPage_Click(object sender, EventArgs e)
        {
            Remove();
            if (HideTab())
            {
                materialContextMenuStrip1.Enabled = false;
            }
        }

        /// <summary>
        /// 删除当前选中的选项卡
        /// </summary>
        public void Remove()
        {
            // 删除时判断是否还存在TabPage
            if (mTC_ImageTab.SelectedIndex > -1)
            {
                if (HideTab())
                    return;
                var SelectedTabName = mTC_ImageTab.SelectedTab.Name;
                var TabName = SelectedTabName.Substring(3);
                //使用TabControl控件的TabPages属性的Remove方法移除指定的选项卡
                htTabImageName.Remove(SelectedTabName);
                tsmi_Index.DropDownItems.RemoveByKey("tsmi_" + TabName);
                NameHash.Remove(TabName);
                mTC_ImageTab.TabPages.Remove(mTC_ImageTab.SelectedTab);
            }
        }

        private bool HideTab()
        {
            if (mTC_ImageTab.TabPages.Count < 2)
            {
                return true;
            }
            return false;
        }

        private void mTC_ImageTab_DragOver(object sender, DragEventArgs e)
        {
            if (e.Data.GetDataPresent(DataFormats.FileDrop))
            {
                e.Effect = DragDropEffects.Move;
            }
        }

        private void mTC_ImageTab_DragDrop(object sender, DragEventArgs e)
        {
            if (e.Data.GetDataPresent(DataFormats.FileDrop))
            {
                string[] file = (string[])e.Data.GetData(DataFormats.FileDrop);
                RollBackMessage(file);
            }
        }

        private void TsmiClick()
        {
            ToolStripMenuItem[] toolStripMenuItems = new ToolStripMenuItem[] 
            {
                tsmi_Gray,tsmi_Complementary,tsmi_Frequency,
                Clockwise180,Clockwise90,Clockwise270,RotateNoneFlipX,RotateNoneFlipY,
                Tsmi_GaussBlur,tsmi_MedianFilter,tsmi_GaussNoise,tsmi_Smoothed
            };
            foreach (var tsmi in toolStripMenuItems)
            {
                tsmi.Click += (click_sender, click_e) =>
                {
                    Config.Model = (FunctionType)Enum.Parse(typeof(FunctionType), tsmi.Tag.ToString());
                    ResultImage = SwitchFunc(ResultImage);
                };
            }
        }

        private void TsmiThresholdClick()
        {
            ToolStripMenuItem[] toolStripMenuItems = new ToolStripMenuItem[]
            {
               tsmi_Lighten,tsmi_Contrast,tsmi_Binarization,tsmi_Polar,tsmi_Robert,tsmi_Sharpen
            };
            foreach (var tsmi in toolStripMenuItems)
            {
                tsmi.Click += (click_sender, click_e) =>
                {
                    Config.Model = (FunctionType)Enum.Parse(typeof(FunctionType), tsmi.Tag.ToString());
                    //ResultImage = SwitchFunc(initBitmap);
                    Open_Threshold_Config(0);
                };
            }
        }

        private void tsmi_Clear_Click(object sender, EventArgs e)
        {
            ResultImage = initBitmap.Clone() as Bitmap ;
        }

        private void tsmi_Preferences_Click(object sender, EventArgs e)
        {
            Preferences preferences = new Preferences();
            preferences.ShowDialog();
        }
        #endregion

        #region 拾色器
#region 调色板
        private void pB_Color_Click(object sender, EventArgs e)
        {
            ColorDialog dlgColor = new ColorDialog();
            if (dlgColor.ShowDialog() == DialogResult.OK)
            {
                var c = dlgColor.Color;
                pB_Color.BackColor = c;
                Color_R = c.R;
                Color_G = c.G;
                Color_B = c.B;
            }
        }

        public int Color_R
        {
            get
            {
                int.TryParse(mT_R.Text, out int r);
                if (r > 255)
                    r = 255;
                if (r < 0)
                    r = 0;
                mT_R.Text = r.ToString();
                return r;
            }
            set
            {
                if (value > 255)
                {
                    mT_R.Text = 255.ToString();
                    return;
                }
                if (value < 0)
                {
                    mT_R.Text = 0.ToString();
                    return;
                }
                mT_R.Text = value.ToString();
            }
        }
        public int Color_G
        {
            get
            {
                int.TryParse(mT_G.Text,out int r);
                if (r > 255)
                    r = 255;
                if (r < 0)
                    r = 0;
                mT_G.Text = r.ToString();
                return r;
            }
            set
            {
                if (value > 255)
                {
                    mT_G.Text = 255.ToString();
                    return;
                }
                if (value < 0)
                {
                    mT_G.Text = 0.ToString();
                    return;
                }
                mT_G.Text = value.ToString();
            }
        }

        public int Color_B
        {
            get
            {
                int.TryParse(mT_B.Text, out int r);
                if (r > 255)
                   r= 255;
                if (r < 0)
                   r= 0;
                mT_B.Text = r.ToString();
                return r;
            }
            set
            {
                if (value > 255)
                {
                    mT_B.Text = 255.ToString();
                    return;
                }
                if (value < 0)
                {
                    mT_B.Text = 0.ToString();
                    return;
                }
                mT_B.Text = value.ToString();
            }
        }

        private void SetColorRGB()
        {
            mT_R.TextChanged += (sender, e) =>
            {
                tB_R.Value = Color_R;
                Change_pB_Color();
            };

            mT_G.TextChanged += (sender, e) =>
            {
                tB_G.Value = Color_G;
                Change_pB_Color();
            };

            mT_B.TextChanged += (sender, e) =>
            {
                tB_B.Value = Color_B;
                Change_pB_Color();
            };


            mT_R.KeyPress += InputLimit;

            mT_G.KeyPress += InputLimit;

            mT_B.KeyPress += InputLimit;

            tB_R.Scroll += (sender, e) =>
             {
                 Color_R = tB_R.Value;
             };

            tB_G.Scroll += (sender, e) =>
            {
                Color_G = tB_G.Value;
            };

            tB_B.Scroll += (sender, e) =>
            {
                Color_B = tB_B.Value;
            };

        }

        private void InputLimit(object sender, KeyPressEventArgs e)
        {
            if (((int)e.KeyChar < 48 && (int)e.KeyChar != 8) || ((int)e.KeyChar > 57))
            {
                e.Handled = true;
            }
        }

        private void Change_pB_Color()
        {
            pB_Color.BackColor = Color.FromArgb(Color_R, Color_G, Color_B);
        }

        #endregion

        #region 鼠标拾色
        Point p = MousePosition;
        
        private void Pick_RGB(Color c)
        {
            Color_R = c.R;
            Color_G = c.G;
            Color_B = c.B;
        }



        #endregion
        #endregion

        #region 左边工具栏
        private void ToolsClickEvent()
        {
            MaterialFlatButton[] flatButtons = new MaterialFlatButton[] { mFB_Select, mFB_ColorPicker, mFB_Move };
            foreach (var flatButton in flatButtons)
            {
                flatButton.Click += (sender, e) =>
                {
                    Tool = (Tools)Enum.Parse(typeof(Tools), flatButton.Tag.ToString());
                };
            }
        }

        private System.Windows.Forms.Cursor MouseCursor()
        {
            switch (Tool)
            {
                default:
                case Tools.Empty:
                    return Cursors.Default;
                case Tools.Move:
                    return Cursors.Hand;
                case Tools.Cut:
                case Tools.RGB_Pick:
                    return Cursors.Cross;
            }
        }

        #endregion

        private void MainForm_FormClosing(object sender, FormClosingEventArgs e)
        {
            SetHistory();
        }
    }

    public enum Tools
    {
        Empty,
        Move,
        Cut,
        RGB_Pick,
    }
}
