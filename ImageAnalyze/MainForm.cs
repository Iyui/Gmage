/* Title:Gmage
 * Author:Iyui
 * Iyui.Github.com
 * Image Process
 *              .. ^BBBBBB7`. >B000BXBBOOH??0>v+H0?OOOO?>COO?OCC?XXOCHHOCCCC7??O777?HC777??77>7>>7O>>>>COC++vv+>>>>>C>>7v=777OC7O?~'``'__:v>C777777777777COCCCCCOCCCCCCCCC7C77C7CC777777>>777_...`'.`~COOOO
               :BBB00X>....?B000XB007???H?~v~O0?OOO?C>OOO?OCC?B%?O??OCCC77??777CHHC77C??77>>>>CC>>>>COC>>>+>>>>>>C>>7+=>77C7>O?^````'__-_~7777777777C77CCCCCCOCCCCCCCCC7CC7777C777777>>>>7^..`'``'`+H??O
              ~0BB0B0~... -B000BX00C?H??0?^==+0OOOOH7OOOO?CCCOB%0OHO77C77C?O77>OH?777???7>>>>>C7>>>>O?C>>>>>>>>>7C>7>+v>>+C7>OO_``````-__~+777777777CCCC77CCCCCCCCCCCCCCCCC777C7>77>7>++>7=..`'```..=HH?
           . =XB00BH_     :B000BB0?CHH??B?:~v=??OOHC7OCOO?CCCOBXX??C77C77OH7777?HO>>O??C>>>>>7C>>>>7OOC>>>>>7>>>O7>7>+=v>=C7>O7_```````-_~C7777777>7>7CCC77CCCCCCCCCCCCCCCC77777>7>>+v=v+>v``''```.. =BH
          . :BBH00?-      ~B000BB0C????HBB^^vv7?O?H+COOC??CCCO?BX0O7C7777H?7777?HC>7??O>>>>>>77>>>>7O?C>>>>>C7>>O7>7>+==v~C>>C>-`````'``-^77777>77>7>>7CCCCCOOCCCCCCCCC77CC77777>>>v=^_:=++``'`'`. . .CB
            CB000O` .     vX000XBHCH???H0%v:v++HCHC>OOOCH?CCCCC0%BCC7777C0C7>77HH7>C?O7>>7>>>7>>>>>COHC>>>>>C7>>C777+v~==~C>>Cv-``..````'-^7777777777777COOCOOOOCCCCCCCC7CC7777C7>v~_---~++-`'''`.... `O
           ~B0000_ ..     >X000BBO?H???HBX7_v+vCHH+7OOCOH?CCCCCCXXC77777OB7>>7CH?>7??7>>>>>>>>>>>>>OOH7>>>>>OC>>C>77+v~~^~7>>Ov-``..`````-_^OC7777777>7>7COCOOOOOOCCCCCC7CC7777C7+^---_-:v+_'''``..... -
       .. :000BO_     .   7B000BHC?H???0X0H^~>v>07>OOOC?HHOCCCOC?X0777C>HH>+>>OHO>CO7>>>>>>>>7C7>>7O??>>>>>>OC>>C>>7vv^~:v7>>C~-``...`````_-=??OCC7777777CCOOOOOOOOOOCCCCCCCC777>~_-_~~::==_'''.......  
         -0B00O` .   .`   ?B0000OOH???HBXH07:>+>?+COCCOHHO?CCC7O7H%H>777BO>+7C7O7>C7>>>>>>>>77O>>>C??C>>>>+>OC>7C>>>=v^::>7>>C:'`.....````'__=H???OOC777777CO??OOOOOOOCCCCOC7+vv~:_^v+v:_^_-''....... . 
       ..7BHB?` .    .'  .?00000O?????HBBHHH^+>77>CCOCOHOCOOCC7CO7BXC777B7++>C=?7>>>>>>>>>>>7C?7>>C?O7>>>>++OO>C7>>>=+^_~+>>7>:'`.....`````-_-7H?????H?OC777O??OOOOOOOCCOCC>v~::_:=+>7+:__-''`......    
        ~BH00_ .     __  .000000O?????HX0HH0Cv7O>7OCCC??OCO?CC77CCCXB7>?0>v>7+~?>>>>>>>>>>>77OO>>>O?O>>>>>v+?O>O7>>>=v^_=v>>7+_``.....``````__=HH?HH??HH??OO?????OO?OOCOC7>=:_:^~+>7CC+:-_'-'`......    
       `H00Bv        =:  .00000HO?????HX0HHH07C?+OCCCO?OCCOOOC7C7CCOX0>HH+v7CvvO>>>>>>>>>>>C>7O>>7??77>>>>v>?O>?>>7+=v::v=>77~'``.'`...`````'__7H????????H?HHHHH??????OOC+=^==+>7CCCCC>^'-_^.........   
       ~B0BC`        >_  `00000?O?????0X0HHHHHH7>OCOCO?CCCO7O?C7C7CCC000O++77:+C>>>>>>>>>>C7>>7>>C?O+>>>>>=7?OC77>>+=v:^+~>>>~v~_-'`....```''--=?????????H0HHH?H?H????O?C>77CCO???COCOC>==++`........ . 
       OB0H' .       O:  `H000HO??????BX0HHHH0?>COCCO?OCCC?7??OC7777C>HH7=>Cv_77+>>7>>>>>7C>>>>>>CH>v7>>>+vC??>7>>7vv=^~v:>C?C=-........```'^+:v????HHH0HH?O?H?H??????C???H????HH?O?OOOC7CCO-....... .. 
      :B0B~         .?^  `H000HO??????XX0HHH?HO+OCCCCOCCCC?7H?7COC7>7C?>H+>7^_C7+>>>>>>>>C>>>>>>>O?=+>>>>vvC?O=7>>>=v=:~==??+_``........``'`_>C7CCCO?OOOCCCC?HHH??H?H?OO??H????HHH???O??OOO?~ ... ...   
      7BBC          `H=  `H000?O???O?0%00HH?HH7>OOCCCCCCCCOC0OCC7CC7>>CC7OH>:^7++>>>>>>>7C>>>>>>7?O^>>>>>vvCH+v>>>>=v^_+O777~-``.........```'_7OC7777CC7COCCHHHHHHHHH?OOH?HH??H000??????OOOH> ...  .    
     '000_          '0>  `0000??????O0%HHH0%%?>7OOCCCCCCC7OC0OCC777CC777>+?=::7++>>>+>>>O>>>>>>>C?>^7>>>>v+OO^+>>7+~vvCO~^>>:-``.....`...`'``-~7CO7C7C7CCCCCHHH0HHHHH?OOH?HH?HH000H?HHHH?O?HO` ..   .. .
   . +BB=           `?H^ -00H0??????H?0$0HH%#B+CCCCCCCCCC7OO0OCO>77>77vO>CC>=:OCOC>++7>77>>>77>7?O^~7>>>>=C?~:>>>>=7Ov~=-~C=:'``.........`'--v>77CC?C7CCCCCC0HH0HHHHH?OOHH0HHHHBBBHHHHHHHHH00~   .  ....
    `H0?.            C0H::B00H???HH??OB$XHHB$X>OCCCCCCCCC7OO0OCO77>>C=~7+C7>C7C>??OCO77C>>>>7>>O?7_v7>>>+=?7_^7>>CHO=::~-=C:-``.........`.`-_^C777CHHC77CCCO0HH0HHHHH?OOHH0HHH0BBB000000HH000C.   . .. .
    _B0+             =H???000H?HHH?OO0X%XHH0%XCOCCCCCCCCCCOO0CCC77777:=7v7^^^v77OOCO?O?HCCC>7>7O?+_v7>>>vv?^_=>>?0+=~:~^_v+_-``.........````-_vC77C?HHC77CC?H?H0HHHHH?COH00HHH0BBB000H000H0000-        .
    vBB~             `OH??HHH?H??OOO0X0X0BHHHB??CCOOCCCCC7OOHCCC7>77+_+7+>::_~++>>>CCC??CCCOO7O?0+=CC7>>=7v::=C0Hv~=~:~:-+=_'``..........```'_^O777???0CCCC?H?H0HHHHH?CO00000H0XBX0000000H0B0Bv         
    C00-              vH???OO?OOOO?B%0HBHX0?O0HHO7HOCCCCC7OO0CCC>7>7~_>>+=::_~v+>>+>>>?C>>CC>C?HC^^77>+v=>:::O%?>===^:=_->^_``......``.`.````-_+O77C0?HHCCC?HH?0HHHHH?CO000H0HBXXXB0000000BB00H. ..  .  
   `H0C              ..70?O??OO?HBBXXH?HHH0?7O0C7?HOCCC777O?HOCC>>7+::7+v:___==>>v+>>C?>>7C>>O??~:~7>>v=v~:>00C>>=v~:^^-_C:'``......```..```'-__vC7>OHH??7O??H?0HHHH??CO000H00BXXXB00000000000B= .   . .
   '00~              .`?B0HHHH0BXXXXB?HHHHHO>>0>OH?CCCC777CC>OCC>>7v_^7+~____==>>=>+>?O>7C>>7??>_:=7>+v^=~?$C>>>v==^_^_'~+''``.........`.````____>777OHHH??O?H?HHHHH?OC?000000XXXXB000000000000H`     ..
   :00'               =B0000XXXXXXXXH?HHHHHO+7OCHH?OOOOOC7C7vOCC>>C~_^7v^_:__=v>v+>+7?C>C>>>O??^::v7>+~:7B#O_>>>v=~^_^_`+~````..``..`.......`-_:_:C777?H?H?C?HH0?HHHOO7?000H00XXXXB000000000000B^ .   ..
   ^BO.               O0H0H0XXXXBXXX??HHHH?C+C+OHHOCCC7CO?H7=OCO>>7:_^7v^___-=v>=+vvO?777>>7O?>_::+>+v~7$#H_^7>>=v~:^~''>-```.......```......'_=>:vC77O??HOC?H?0?HHHOO7?0B000BXXXXB000000000000Bv .   ..
   ~B>               vBH0HHXXXXXXXX0OHH000?C+>>H??OCC77C>7?0O?CC>Cv__^7+:____=v>=+=>HO7+7>>C?O:_::>>+~O$$0^'~7>>==^_~_`^v````...............``__7C>C77CO??7C?HHH?HH?OO>HHB000BXXXX00000000000000?'   .. 
   ^B=              v00H0HBXXXXXXXX??0BX0HOC+>OHH?CCC7C777>7v?0H>7~_'^7v____:++vv=vC?Ov~>>7??~_:_^7+>0%#H^''v7>+=~::^-`='````...............``-_~CCC7777?O7CH?HHHHHOOO7H000H0BXXBB00000HHHHHHHHH0C. ....
   _B^             ^B00HHBXXXXXXXXXO0BX0H?CC+CHH??CCCC777C^7^C?XBC__'~7~-_-_^+v=v~v??7-=>7??+-_:_~>>X#$0^-`'+7>==^_~_`':```'`.........`......`'_-+OO7777O77O??HHHH?OCC7H00?HH0BXXX0H0HHHHHHHHHHHH0= ....
   '0:           ..O000HHXXXBBXXXX0HX%BHHOO7+OH?HOC7CC7C7>:7~>COB%C:.=C:-_-_^+vv=^>HO:_+7C?O:__:_~7%$$C:_'`-7>+~=^=v^:~^_'```'``````.........``-_:C?C777CC7???HH?H?CO7700HOOHHBXBB0HHHHHHHH?HHHHHHH-.```
   `?_            _000HHBBXXXXXXXXXX%X0H?CO77??HHCCCCC77C+:>==OO>H#B:~7__--_^+=v~~CH^-^7C??^____->%%O+:_-`.-7C>7>=+~-_^___'.....`````````..`.``'_-v?077OO77???0H?HOCO>OH0H?7HH0BBB0HHHHHH?H??HHH???>``'-
    C^            ~B0000XBBBBXXXX%%XX%0HOCC7O?HHOCCC7C77Cv_v=~COC~>$$?7'_'-_~+=v^=C=-'+C?O^-_^^~CB?>^^_-'--=OC+v:~^-:v+v+>>7>++=__--'`````...```-__7HHCOC7C???0???CCC>?0HHO7?HH0BB0HHHHHH???O???O7+v:'''
    =v    ..   '~+H00000H00HHBXBXBHX%X0?OOCC?HH?CCCCC77C>::^+_7?C:-vX#%C_`-_~+==^v=-'=7?>_-__~C>~++v=_:v7~-=7==>CHHBB%$*@@@@@@@@+--__'``````.````__~CO?O77O??H0???CCC>?HHHOCOH?H0BH?H??????OC77+~__:v^.`
    -7    . `~7HBB00H00HHHH?0XBXX0?HBX0OOCC?HHHOCC7CC77C=:::+'+?C:_'-CB$C`-_~v=~~+^`~7?>'_:___-`'>+v:_=?:``v7CH7vO*@@@@@@@@@@@@@*~.``````````````'-=?7C777O??H00H?7C7>HHH?COCH??H0H??????OC>=~_'_^v>CO_ 
    .7`    :?BB00B000H??????HXXX%0HHH0?COCOH?HOC>CC7C7C7^:^:v-vHO:-'.=~_O+:_~vv~=+'^CO>-_:_:_-'`:7+=-_~~..'OHO~~%@@@@@@***@@@@@*@*~.``'```````````-=O7O777???H>==+CC>7H??OCC7O???HHO?OOC>+=:''_~+7CO?H?_
     __ .'>BB0COH00H?C??O?O?0XXXBHHHHHOOOC?HHHC7>CCC77Cv::::=^=??v~_`=~''^v_~+v^v^^CC~`-____-```=>>___^'.'70v=O*@@@@*#$%%%%#@@*@@@#_.`````````````-v7O777CO?HC....^O+CH??CCC>C?????OC7+=:-`':=+7O?HHHHHH
     .- :HBB?=>00HHOCO?O?OO?BXB%7?HHHHCOOC??HOC>7C7OC7C^^~^^~^vHO_:_^+~-'`-_~+v^v=7+-':____'```'+7~-__-`^C?O0$@@@*#$%%%%%%%%%**@@@@H``````````````-~7O77>C???>'--'`_+????7CC>7?OOOC>=^''`-^v>CCOHHHHHHH0
       ~B0B>^OB0??CO????OOO?B%B=^0HH0?COC?HHHC>>CCCC7C>v==+?00CB0^~_`~=>=`-_+>=^7+_'-___-'`````^7v-___:=^~+0@@XX*%%%$$%%%%%%X$*0*@@@O.````````````'_CO>77O??Hv_^:_-`'+???C7C7+C7>=_-'`'^v>CO?OOO?HHHHHHH
   .. `H0Bv`?B0??CO???O?OOO0%?_ ^0HHHCOCOH?0O7vC77OCC7:^^:_~$@@**H~^+v__7~_~0>~~=`'_:_-'``````'>7___'-=+=OX@#C~$#%%%%%%%%%%%%%*H+#@@@7```````.````''+C>77O???v=~~~_-``>?OC7>>==^-```-'^>CO??H?O??HHHH00H
   .  +BBC`CB0??7C???OCC??0B=.  ~BHHOCOC?H00Cv7CCCO7O~::^_v$@@*#*@#C_>7::_:H07~=^'__-'````````~C^'_''^-:O@@$v^C@%%%%XXX%XXX%%%$%^v#@@$C_`````.....''+7>77????=:::^=_'`-COC>v~-`.`-:-':+O?????H?O?HHH0000
     -0B?`>B0?H7C??O7>O?HH>-  . =0HHOOC?H?BO>+C77OCC>::^:=#@@%+O**@@Xv=>^^C7=7~=^__'`````````_C=`__`-''-0**7~~B#XBBBBX%%%BB7^=X$=~+*@#+_''````..`.`:7>+>C???7_::::^=-'.~7+~-`.`_^~-'~+CO???H?HH?HHH00000
     >B0:=B0H?CC?O77O?C>~'      v00OCCOH?007+7C7OH7C+_::^0@@B~~%$%#*@@B=v7~-_>^v_-'`````````'7v`-_''-':X@@?~^:$%0B00$$%%%#7   O#~^~?@@#^.````......^7v>>OOO?~:^::::~^''_^-..'_=>+^'~>C?????HHHH?H0000000
    -00>vB0H?7C?7C?O~'.         vB?COOHHB%?+>O>CBC7B7_^7%@@H^^7#X%%$#*@*?:~__+~=```````````'+^`-_-'''_B@@?~- '#BBB0%$%%%%$= `>0$~.:v#@@@O````.....`v+=7>O??>_:::^::_~_'`.._~v+77=_v7O????H?HHHHH00000000
    vBBv00H?CC?>CO^`.           +HOOO?HBXXCvC>>?B>?$C=7>%@%~~`C%%XXXX%#*@?~_-=v=``````````'>~.-_-''''v%@B^:  _#0H00#$%%%%%B+7+?#= .v$$+?#?-``....._7=+>C?O?^:^^:::::_-..'~v7C>>v'~7OO????HHHHHH00H000000
    ?BC>BHHOCO>OC'     .        +OOO?HBXBH>>>>C0OCB%H^:+@@7^` ?%XXXXBBX$*@%7:~v^````'``.`_>~`-_-''''_7**^^'  ^*H?HH#$$$$%%#%+.7#v .+H?'.'^_`..... v>~>7CO?C~v====^:'`.`'_>CCC+v-:>C????HHHHH0000B0000000
   -00+000?C77O~ ..         .. :OOO?HBBH0O+>v7HB7H%X?^_X@$=_ .?%XXXXXXBH$@#v:~v:`````__^vv-.-_-''''`^%$?`^.  ^#HOC?*###$$%#XvvO$=  >O=``````.....-7v~>>OO?v^:::::^`.`-:'-COO7v-'vCOO???HH00000000B0000B0
   =XOO0HHO7C>_  .          ..^OO??0BB?H0C++7OXHOXXv==>@@B~`  ?%XXX$X%O.?*$O-:+_``````-_-''--''''``^Hv7:':`  _#H+=O#B??X#$*X++C#~  C+```````....`+>^+7CO?>_:^:::-``-_~:''7OC+-`=7O????HHHBB0000000BB0000
 ..C0O00HO7C=.              `>?O?00BH?H0?>v7OXX?XXH:~7#X$X~. .?XBB%$X%C:B$Ovv:>-```````''''''''```:C-`^''_-  `#Bv^:-.  =*#@Hv=O%- `H-``````.....=>=~7>O?C::::::`.`_::~:'-CC>_`^>C?O??HHHH0XB0000B00BB0B0
  `0HH0H?>7+..             .7?O?000HO?HBO++CBXH?XXC::0O_O#=`  HX?H%$$$$#?#Cv__>-``````````````````~-``''''_. .X%v`     :***C^~HX. -v.``````...._7v^=7CO?v^===:_`.-:::~:'_C>^`_v7C????HHHH0XXB0000000BB0B
. _000HHC7+`.          .. .+??H00HHOC?HH7v>?XX?XX%7_:+^:~X>`  ?XCC$*#$#%+$7v-`>-`````````````````-'````''`_'  ?#^ .    v@@%=:=B0  '''``````.`.'>+~_v7OO?~:^^^~_..-:::~-`:7~--=7CO?H?HHHH00BXXB000000BB0B
  ^XB0H?7+``.            _7H0?HH0HHOOH0?7vO0B0BXX%>:~=~:_>H-  O%+vHO0$#*?BO__`v_````````````````````````'`''  =*-      0@@O::>#O  ````````.`..~>=::>C??+^_^:::_` '::^:'`^+:'^>COO?HHHHHH0HBXXX0000000BB0
  =X00HO+` ..         .'vH0?7=OHHOHO?H0O>+?H0BXXX%>_~~=:::O=  +$=`. `%*@CHO-_`:^.`````````````````````````'`  `0`     ^*#H=_~H*^ `````````...'>v^_v7??=~^:::::_- `_::'`'~~__+COOCOHHHH0H000XXXB000000BB0
  >B0HH7`           .^7H0?v''C?BBOHH?HHC+OO?BXXXX%7_~:=^::^v` :7 . `H*@#vHC`-``_-``````````````````````````'.. ^: .  .^=^__^O*7 `````````...'>>^_~7CHv_=~::::::' ._:'`'_=:_+7OOC7O?0HHH0000BXXXB000000BB
  CBH?H^ .       `:v?0O>^`  +HBXB?HXHH?77H?HBXXXBXO:^:~~:^:^_ .=...v@@@?~Xv.-'`':'```````````````````````````  `7_'`'-'`''_>*B.-'`````````.`+>=_^>>?^~:^^::::::'  --`'-:=_+7CCHOCC?0HHH0000BXXXX0000B00B
 .O0HH7...  ..-~v77+=:'    -?BXX0??%0HOC?H?O0XXXBXC:^:~~::^:^` :?~_~CHC^v$_.-'``':-`````````````````````````'.  v*0+^_---_>#X-_-``````.``..v7v_~>>?=`~~::::::::' .''---^_=7CC7?OOCOH0H000H0BXXXXBB00BBB0
 'H0HH-      .``..    . .. ~0XXX0??XXHCOHHOOHXBBBBO:~=^=::::^-  O*+-''`-?B.'''````-'`````````````````````````'.  +*%O+~=>H*0-~=-````````..=7v:~>7Cv`':=:^::::::' .'--___~>COC7??COCH00H0000BXXXXXXB00B00
 _BHH^                    'OXXXX0H?X0OCH??OCHBBBB0?:=~_=~::^::` .CX7^^~>X:.`''```````````````````````````````'``. :OBB0XX07:+7==`````````^7v^^>7>~``_=~::::::::`  '--_-->7COO7?HCOO?00H0000BXXXXXXXXBXB0
 ^X0=                    .7BXXXXHHHX^vHHO?OC?0BHHHHv:=:^=:::^':.. _H$$$%^.'``'``````````````````````````````````'=_`'-_^^v+7+>=-'```````=>=:=77='``-v^::::::::_`  .__-'v7COOC7?0COOOHHH0000BXXXXXXXXXXXB
 ~BO`.                   =HXXXXBHHHO'O0?CO?C?HB?H?HO:=^:=^:^_`^v.` .~v~'''```'```````````````````````````````````~+~_-:~~::_v:-'`.``'`'+>~^v7C^`'``:^::^:::::::`  `--`^>COOOC7HBCOCO?BH00H0XXXXXXXXXXXXB
 =X^                  . -H0XXXBHHH0+'HB?CCOC?O0OO??H=:~_~~:::`:v~:~-..-~:`````````````````````````````````````````````````'``'`````.'^>+~~>C+:'''``^:^===:::^~:. .`-`_+7COOOC7HBCOOOO0HHH00XXXXXXXXXXXXX
 =O                  ...OHBXXBHHHHBv:HXH7CO7?7?OOHH0>_:^==::_```=_=+77v:``````````````````````````````````````````````````'`````.`.`=>v~=>>:'''''``~^=~:^^^~~:-.  '''v7COOOOC7B0COOCOH0H0H0XXXXXXXXXXXXX
 +=                   .>0HXXB0HHHHH7=?0BO7O7O>COCHH0H^:~~~:^_````'^-``..`````````````````````````````````````````````````````...'-:+>++v>~''''''``-~~=:::___-_-. .`'=>CCOOOC7OXBCO?COH000HBXXXX0XXXXXXXX
-?'                  '7>?BXX?HHHHHO>C7H?0?7>CC+OO?00BH^^=^::_`.```.`````````````````````````````````.............`....``'-''`-:v>>77+=:_-'''-'''`':^^^:___-___-  .^+>CCOOOO7>?%0C??OOHHHHHBXXXX0BBXXXXXX
H>.               . :HvvHXXH+HHH?HO_+>HOO07+CO+COO000XO_v~:::`..````````````````````````````````````.............``...```'^=+77+v=~:-''''''''''``-^::::____-__'  .=7CCOOOO7>>BX0C??OO?0HH0XXXXB0BXXXXXXX
0- .              .+0O-O0X%=70H?OHC'=C??7OC+>?7>HC000BX=~v^:_'`....``````````--``````````````````````.................```````'''``'''''''-''-'''`:::^:-_______'  `+CCCCOO7>vC%XHC??OO?0HHBXXXXB?HXXXXXXX
C .   .          `CBH-:H0%O'?HHOOH7':H?O>>O++??+C?H0BBXO_=^::``...``````````':_```````````````````````.................```'''`''''''''''''''''``-::__:________'  _>CCCOO7+v=0XX?C??OO?0HHXXXXX0C?XXXXXXX
_ .  .`       . '>00^ =0BB'_H?HOCH7 'HOC>+C7+COC>?00BBXB~^~::'`..``````````'-^-````````````````````````...................````.``````'''''''''`'::+C=~:______~' .~7COOO7+=~OXXXOOH?OO?0HBXXBXBH=HXXXXXXX
      `.      .-?H0=  >H%~ ^HH?OCH7 '?C7>+>C>>CC?CHBBBXXC^~::'`.```````````__~'````````````````````````````..................`'-----_-'''`''```__>%%XB0>^_-:>+`.'v7CCC+v~~O%XXB7OH?COH00XXXXBH+^BXXXXXXX
      `.      `C?HO   7B?. ~H??O7?7 'CCC>++7C>O7O0H0BBBX0~=::-````````````-:_^````````````````````````````````............_~v+CCCC7CC77+v~_'``-:=%XXXXX%?>>CC=`._+CC>+v~~?%XX%?CHHOOO0HBXXXX0?->BXXXXXXX
      ..      ~HOH_   CX^  =H?CC7?+ `CC7>++>777CCHB0BXBBX==::-``.`````````'__^-``````````````````````````````````......`:+C7>v=^^^^^~=v+>>7>~_:^B%%XXXX0OOOO7~`.^>>+v=^~OC?BXBC?H?COO00XXXXX0=`?BXXXXXXB
             .OOH7   `H0`  vHOCC>O+ `77C>+++7CCCC00?0XXX%>~^:-``.````````'`'_~^`````````````````````````````````'```.`^>7+^____::_:_:_:^~vvv>7C?BBBX%XHOOCCC7^.`~+vv~:=Cv'-_O??HH?CC?HBXXXXB> ~0BXXXXXXB
             :?O0=   _0>   =?O>7>O= `7C7>v+v>7CCO00O0BXXX?v^:-````````````'`'-^'```````````````````````````````````._v+~^:::^::^:::::::::~==vv+++>>>77>7>>+>+:.-=~~~~>7='-:=C?H??CC?0BXXXXX>.'?0XXXXXXB0
             =H?H'   :B=   =?O+>+O^ .+C7+vvv+7COHB?CHXBXBXX~__``...```````````'````````````````````````````````````~Cv::^^^^^^^^^^^^^^^^:^^^=>>+==+7>>>>+>++v_._^~v>7=--~>?H???HOCO0%XXX%B= .CHBXXXXXX0?
             =?HO``. :0=   ~OC+++C: .=C7>++vv>CO00OOHBXXXXXv:_`...````````````````````````````````````````````````=C=^^~^^^^^^^^^^^^~~~===~~~=>>>+vv>>+>>+++v_.~+CC>=v>OHH??????CO+_7B%X?_  =H0XXXXXXB0:
             ~?H> '. :0=   ^OC+v+C-  ~7>>+vv++CO0?CO?XXXXX%>__'``.```````````````````````````````````````````````=C=^~~~~~~~~~~~~~~~====vvvv++>>?7>+++>>>>++v-`=+77CO??OOOOOO?OC?+--'_C7.  _HHXXXXXXX0= 
             -?0+    :0+   :OC+=>C`. :>>>+v+++7?0OCOOBXXXX%C_:'``.``````'```````````````````````````````````````:C+~~~=============vvvvv+++++>>7??>>>++>>+++='-v++++>>>>>>>>>7OC=--_-'-:~-`7?0XXXX%XB7 .
              +0O .  _HC'  -CC+~>>.. ->7>+v+v>CH?OOOOHXXXXXH::-``..````````````````````````````````````````````'+>vvvv==========v+>+++++>>>>>7C??H7>>>>C7>>+~':vvv+vv++vvvvvv+v_'-_--_---^+?BXXX%XB07'  
              .7B_.. `OO^  -7Cv~>= . `+>>+v++7HHCOOOO?BXXXXX~_-````````````````````````````````````````````````v7+v=^_-_---:===~:vvv>777CCOOO?0HCC>>+>OC>>>+~'~~~~~~~~==v==^_-'------------:O%%XXB?_.   
             ..`+> .  7O+  .>7+^>~ .. ^77>v+>OHOCOOOOOHXXXX%+__````.````````````````````````````````````````'`^C=_-'-''''-:_:77>77v=v+>77>7CCOCv+O>>>OO7>>v:_'^~vvvvv==~:_-------_----------'~H%0+` .   
             `.. _:`  >C7-  =7>~>^ ...'>7>v>CHOCCOOOOO?BXXX%?__'`...`````````````````````````````````````````-7^'-----'''__``^>=v+>7>>>>>>>+==^~O7>>COO7~_--``_--___--------_----_-------------+~       
             .`   '-. vO7=  :C>=>_ ... ~7>+7??CCCOOOOOOHXXXXX^_-`..`````````````````````````````````````````.=~`-----''''-__-`=>~^=~v====~~^^:~=>>>7OOO:`''-``------__-'-_-------------------_-'^:...   
              `.    . ~O7>- '>7v>`  ...`+7>OOCCCCOOOO?O?0XXX%7:_````````````````````````````````````````````'v``__-'``'--''-''-~v+~^:^^^:::^~^:`v7>>OOO:.`'`.`'``''-''`'___-----------------_----^_'..-'
              .'.  . .:C7>v. ~7++`  ....:7CCCCCCCOOOO?O?OBXXXX~_'``.````````````````````````````````````````--`-_-````'--'-''-: `^+>+v===~~^-`..-C>>7OCOv``'.'```''`.`'``''-_-_-----------------''':~:':
               .      `7C>>_ '>>+.   ...'7C77CCCCOOOOOO?O?XXB%>__'``.`````````````````````````````````````'`'_`--````'----''`:'.. .`_^:^_'`'```. _77>>7CO7^'.-`''``.'``....``''---------------'_^~^:-.^>
       ..            . v77>^. v7+.   ...-C77CCCCOOOOOO???OHXXX0^_-``.```````````'''`.``.````````````````_~-``----````'--'''''^.......   .'----'''`'~>77>>+=`'==^-  `-```.........'--__------':=~-`...:+=
       '.          . . -C7>+' -7+.  .. .v777CCCCOOOOOO???OO?HB%?__'``..```````````^~^::^^_-`-:^~=========_``'``_'``.'---'''`-_........`'-:==~~_--_'..-:^==^.'^^-   `'```...........``------:=^'. ...`==C
      =_ .         . .` =7>+v' ~>` .. -v7>7CCCCCOOOO?O??O??OC?B%?:_'...``````````'`_::__-''````'''``''''```````-'```''-''''`:'......''-^^^^:^^^^~---'`  .`'.```.   .'```..............``-^:_'.......~=CH
     .?: .           .` `>7++v`.+`...-77>77CCCCCOOOO??O??O?C7OOX%?:_'``..```````````````````````````````````````-`.'--''''`':......`':v~--_-----=>~:--'..``.'`'`.   `'```.............`::'........ _=vH0
     .O~ .            .  ^C>vv=.^-.._>>>>777CCCCOOOOO?OO???77?vH%%O_-'`.````````````````''''''`'`````````````````'''--''''`-_.....`':v_----_--__-~^~~__-`'.`'``''   `'...............--'...........=^C0H
      +7...            ...v7+++=__ ^77>>7>7CCCCCOOOO?OOO??O>7?v=%X%C--'`.`.`````````````''-'''''```````````````````''-''''`:'...`.'-~_--_------_----:=_-''``'```'` .``... ...........`............'~v?HH
      _0=  .           .  '>>>v+~:vC7>>>>7>vCCCCOC0HO???O?7>7?v'XXB%+-_'`...````````````'''-'''````````````````````''''`''`:'``.`''^:-_--------__--_-_v--'.''`..`'.``.....    ................... :~C?HH
       >0+-  .  .    .     ^7>>>777>>7>77+~v7CCCOOBBO????C>>CH~ H%BB%C^-'`...``````````````'```````````````````````'''`'`''^`````'::----_-------------^~-'`'`..``'.'`.....        ................~vOHHH
       _?HHv`     .     ....=77777>7>77+~~=+7CCCO0XBO???O7>>O?: ?%X?0%Bv--`...```````````````````````````````````.`'''`'`-^^``''''---------------------~_``_--`''..'`.....          ............ '~>??0=
       .v??H7:`            `=C>>>>777+~~=~v>CCCC?XXB?H?O7>>>O?`.0%X0OHX%+-''...```````````````````````````````....``'''`_^_:''```_---------------------^_`'-__--'..'`.......     ..   ...........-=7?H>.
        `>OOOO7=_`.    .`-~+7>>>77>+=~=v=^>CCCOO0XX0??O7>7>CH= ~%XXB?O?B%7_-'..```````````````````````````````....`''''^^-__`.`'-^-----------------------''----_`..__-'`..  . . `^C~   ..........-+O?O`.
       . `>OCCCCC7+vvvv+>777>7>7+v=~=vv=^+7CCCC?XXX0?O7>>>CH> -0XXXX??O?X#H~-'...`````````````````````````````..`.`'`-^_-_'`.`'`^_----------------------'_-^^^__.`.'__:_--'`......C7     . ......:>OHv .
       .`.`~7>>>>>77777>>>>>+vvv=vv+vv=~+77CCC?BXBHO77>7>7?>==?%XXXX0O?OH$#XO~``.`.```````````````````````````...``_~:_--`..`'`'~--------------------__--_-_::^:_`.`__--_-_'''`'`'>0_.`..        ^7O?-  
         .  ^7>+++++>>+vv==~~=vvvvv+v=~>>777CHBBHO7>>>>>7H0C0BXBBBBBHO?OH%%X$X+-`...``````````````````````````.``'v+_-_-.  `-`._^'-'-----------------_:'-___---__'..`-___--'``.  ._H?--_---'--'` ^C?+   
          ..._+>++++vvv==vvvv+vvvvvv=~>>>>>CHB0?C>>>>>7CHH??????O???O?O??%%?X%$H~'``.````````````````````````..`:C>--_-.   .''`_---'------------------:'_-_^~^_-_'.   .'-___-``.. .70^     ..... ^C?_   
          ... .:v>++++vvvv+vv+++v+v~~>>>>>CH0?C>+>>>>CO????OOO?O??O?O?OCH%XOX%%$%C_..`.```````````````..````.`'v?>----'.   .'-`_-'----------------------_----:=--_`     .''-_-'`.. =?:           _CC.   
           .    .-=v++vvvvvvvvv+v=~v>>>>>7?O7+v>77>77??O??O?OOOO??????7CH#BOB%%%$$0~'....``````````````..`.`-~C?7----_'     `''_--'------'-------------_------^~-_'        .`-__'` '- ..         'C+ .  
            .  .. .```:7C>>+v+v=~v>7>>>777+vv+>v:_^CO????C7CO?O?????C>>O0#0O0%%X>7HO>+_...`````````````..._+COCO:---__-.      ..'-------'---------_----__------~=^-.       .._~_---`. `+: `.     .7= .  
            .   .. ._vO?O7>vvv==>>>>>77>v=v>+~'  `+????C>7O????????7>+O?B$?O0%$C'~+7CCC=`..```````````.`:+O?CCO^--_--__'       .`-----'''---------_---___-__---__^~-        `::=~-__-`.:O~'.      +~    
             .   `=COC>+vvvvvv>7>>>7C7v==+>~'...^C?O?C>7O???O????C7>7???X%?OH%$v_CCC>CCO7~`.````````.`:+?OCCCO=-_--___'.        `-----''---------__---------------_:`       -:::~=_-__'.=+ .    . :v    
         .. .  `~CC>vv+vv+v+>77>>7C7+==++v' .. ^????77OOOOOO?OOC7>>>C?O?$BOO0%%~_CCC>=7CCO>^..`````'^+~^CCCC?v-_-_----.      . .'-'-'-'-'-------_------':---------__-..     -_:::^v:--_```.       .=.   
         .   -v77++++++>+++>>>>>77+v~v+v^. .. _O??C++>+++>>+>>>>C77+7??X%HOOB%X^-777C~:+CCCO>:```'^7OO^_vCCO+--_----''         `---''-'''------------''`:_--------___'.     '___^=~v~--_-.`.       --   
          ._=>>++++++>>>>>7>>777+==vvv:' ... :OOC7>777CCCCCCCCCC>=~>?H+>>OOOB%X^_7777C~_^v7CCO>++7OC7C=-^7O>____--``''       ``_''-'-'-''''------'''``. ::-------_____. ..`.`___:^^^~~:---'.        '.  
       . -=>>++++++>77>>>>>>777+~v++v' .... 'OC7>>v~^::^^^~=~^_-.-7??^`.^OO?X%X^:CC7C7C:__:=CCCCCCCC7C=`_>7_-__-`...'-.    .''`_`'''''-`''------'```.`. _~------::__-_' .'_`.-~:___:_:=_---'..  ..``'''-
    .. .~>>+++++>>7C>>>>>>>77>v~v++=`... ...vO>~'               ^OHO_   =OOH%%%~~O777COv____^+CCC7CCCCv_v+_-_-'`..`'-_-``.''``._-.```````'---'```... .. 'v----_-~^____' `__:`...'-_::::=_-_+-''--''```..
    ...=>>+++>>7777++77>>>7>>==v++=....... 'C=`               -7HH7- . `>OOB%X0^vO7777C>____-_^=>CCC77+~^_-'`...``'_-^---`'....:: .`.```'---'`...... .. .+--_---+~^:__' .-_=:    .`-__:_~::C:_'`........
   ..'+>>+>>>7C>v>+>77>>>7>>==v+v+'....... ^v  .        ..``_v??+_. .  :O??%X~:_77C7777C~_____-^==v~^:---'``..`.`'_-^:`_''.....:^..`.`'----'`......     .v------+=~^:__..-__:`  . . `-___~:C~'-'`.......
.. .~7>>>>7>7>^=++>7>7777>>v=vvv+-........._- .     .. .`''_:^'. .'-^:_v+7OB0:-~C77777777_____^~-''''`'``..``..`--_~_`'''`....._:`'''-''--'`......      .~-----_7+=^^~_'.'____'... ....`'-:>v--_-''```.`
...=C>>>777Cv'~>>>77>>>7>>v=vvvvv...........`.        ':-..    '::_-'''````':__>77==77>7C=-:_-=-````````.   ..`--:=-`''.'`...`.__'---'``'``.....         ^-----:C>v==^_-.._____'   .''. ..`^^----__-----
. ^C>>>7777v`~>+>>7>>>7>>+=vvvv+~..............   . . _^^^` `-:_'```'``'''```-~C7>::777777-__-=_```````.    .`--:='``'.''```.'''--''`..``.``''....       ^_---'=O7>+v^::..-_____`  ..__'`...'--_---_--__
.-C>>>>77C^ :>>>>>77>>7>7+vvvvv+~.................... '~_:~~:_''`'''''''`''``->>=___+777>O~-__~_'``````   ...'_-^'``'`.-'``''''-''``...``'''''```..      _~'--->CC7+v~~^`.-______.   '___-'`..'-___-----
'77>>77C>_ `+++>+77>>7>>>vvvvv+v=`.....................:::~^'`'''''--'''''''`-:-_:__=7777C+___=_-.````.  . .`--^-.``-.`_-''''''-`.....`'''''''`''```.    -v'-'^OOO7>+++~' ':_____'   .-_____-__-------:=
C7>77CC=` .+>>>>>C7>7>>>+=vvvvvvv_......................::''''-_::___''''''''''--'__:>>77>C^__~__`````` .  .`_-^'`''..`'```'```-.  ..`'-'''-'''-'''''.   `v''_7??7C777>~_.`:______'.  '_______>>+++v+7CO
C>777C+...~>>>>>77>7~~7>+=vvvvvvv='.``````...........`.`-_::^~^:__:_'''''`'''-'`..-__+7>>7Cv-_=__``````.....`_-^_'`.  ..`''``.._.  .`'''''''-''''''''``. `v''=??CCCC77>v^..__::___-'. .-____-_~CCCO??OOC
77C7C+.  ->>>>>>77Cv.^>>>vvvvvv==v~``'```''''''`````````.`````-_:^_'''''''-''.   .'__v7>7>7>__~:_```````...``-_--... ..`-_`.`.._...`'''-'''------''''''` -~`=?OOCCC777>+='.-:^____'_'. `-____-_+CCCCOCOC
77CC7' ..v7>>>>>7Cv. ->>>+vvvvvv=~:.`'`````.````''''`'''''''''```_-''-''-'`.  `-`.`__v>>>>>7^-~:-````````````'''--````''`_'....-.```''''----------'''''' ^^+?OOOCCCC777>v_.-^_____-':`  `_____-^vCCCOOOO
CC7C-.. _>>>>>>7Cv....v>>+vvvvv==^'  .     .        .......```''`'''''''`.   `___'`__>>>>>>7^-^^-`````````````'_-_:'''`...'....-..'''-----'''----''''-''`7O?OOOCCCCCC777+^.':______'--.  `-___-:^vOOCOOO
C7C: ..`+>>7>>7C^. .. ->>++vv===^'.                             ..          `'-___'-~>>>>>+Cv__~'``''''-'-''```---~'``....`... __.`''-''_^v>>v==v+v:-'``_??OOOOOCCCCC777>='.-______-`-`   .-_::_::=COCOO
CCv  . -77>7>C7_     . _>>+v=v=~-                                 ..     ...'`'___`-v+>>77C7=-_:--::_:^~^:_-''`'_-:_...... ....`v-'`'^=+=^:_:::_:^~v++=-=?OOOOOOOCCCC777>v_ -_______-'-`   `-:::_::vOOOO
7C^    _777>CC- .   ....`~+>+v=:.              ..........````'`'''-'''`.  `__-_^^^-~7O????>_--------''''-_^^:---_-_:.....   . .._=`~+~:_:~=vvvv++=~++=+CHHOOOOOOOOCCC777>+:.'________'`'.   `_:::::_+OOO
7C-    ~77>7C_`..    .....'_^~^'            .``'''''''''''`'_-''-''''-__'`^+OOOO?C^=OHHHCv~'`'....``````'''-^^:_---^`..      ... ^7+_:=v=~==~^+7>=~++>+>700OOOOOOOOCCCC77>_.`________-`'`    `_:::::^COO
77'    v777O~  . .  .........``.      ......`'''''````.``.'_'''-___`'`'-_^vCOO???O==7C>=:^:'':--'`..`````````'_:~:-:'..      ..`_+^:v+~~====>7+=+7COv^=v^vC???OOOOOCCCC77+-``_________-''.    ':^^::~COO
C7'   `777O+.   .  .........``       .`''``'```````......'_'`'__-__-```''-=+v++77H~-:----'--`'-''`''''''''`'-_----_>^.       .-=vvv+v::^~^^_~v::-_^v==+>+v++C0OOOOOOCCC7O=-'.-_______-__-'.    '-^~:=OOO
7C-   `C7C7`..  ...........``.      .```.```````.........-'''______-`'___:v=v=++?=---''`...```'...````````--_-_--vHB7 .   .  _vv++>+~~~==++v>vv==^=v--:~>C+v+>HOOOOOCCC7O~--.-______-__---`    .''~:+OOC
CC^ . -CCC' ..   ..........`.  .  ..`'..................-_``_____________~+==v+?=--'```....``.'`.....```'--__-':CB0H0'.     :+v+>C+=~===v++C7v+>7>C>+v::^~+:_:>HOOOOCCCCO~-_`'__-______-__'.   .`'^^>CC?
CC>` .>CC-     ...........``.    .`''`............  ...`:'`-_____________vvvv+Ov-'```......``.'`....```'_-__--=?00H0X~ ... _v++v7vv~vv+7OC7+^^^^_v77C>+v^^:=---7HOOOOCCCO^-:'`-_________-__`     ._~>CC?
C7C>'^CC: ..  ...........`'.    .```.......... .    . `~-`-___________--^vvv+CC'`.``...   ..```'...```'--_--_>HH0H0B0> ...:+v=:+vv=>7OCv^:==^:^__~~~=+++v~^-~-':?OOOOCCC?^_^'._________----'.     `^>7?>
>CCC77Cv      .`-.......``.   ..```......            -7_`'_____________-~++v>H:......```````''`'`````'--_-'~?HHBH0O>?0^ .`v+~=~=vv7Cv^-_:~C>>^__~~~^^:^=>~^_-_``^?OOOOCCO:^~'.-________--__-`      '=77>
._+C77C>^__-:^=:`......``..   `'`........       .   ^0=.`'_____________-v>vvH0~--:^^::_-___---``--'`-_-_--vHHH0H0?+v70B^ =+===:++>C~--:~_=>^+?::~^^:^^^_~+:^-'_`.>?OOOCCO~=_-.-________---'''.     ._++>
. '>77CCOC7>=_`........``.   `'`........     ...  '+0C```____________--=7v=OB?~^^:::^^~=^_--_-.`_--'`''_:CHHCH0HH++vvOH0++=^+-=v>7~_-^^-_7~^vv7~__~7?OO>_'v_^-_^`^OOOOOOC7_-_`'________--'`.'`     ..^++
. ^77C+`....  ........``....`'.........         -v?0H:```___________-_=+v=7BB>--_____:~^:~^:__``-----`'=OHO>C0H0>++vv70HX+~>-:+>7^--^:-.>::7v'7~^7?CCCC77--=_~_~:`7?OOOOC^-__-`_______----`.`'.      '=+
..v77C~     .........``....``........ .....`'-:>00HO>```-_______-___~++vv+0B?_-_____~^_-_-_^~_'.--__::vOO7+>0H0C:=vvvO00?v>=-~++^-_=~^'.=:^v=:>+O7v=v7>v>O--~__:~.+?CCO7:'___-`-_-_--'''....`'`       _v
.-777O~ ............```...``........  .  .`':~v=~:-:_```_________-^++vvv+0B?_-__---~_-__-----~:.~7OCCO>vv=+000v-^_^vv?HB>=^_^+7~~7O7>=++v+v=~7>>=v++>O?7v>7'_=:_~::0C?>_-___-_'-_-__---'.....`'       .:
 _C7CC+. ...........``...``.........               ~'`.'________-~+vvvvvO00^----:~~~--__----~C~.vOC7+vv==+HHB+-_:__vv?00=^:_=>v~OC+v:^:^+vv^^+~->v+CHO=_==7v`:::^~_H?>--_-___--'_-_----`.....`'.       `
 _C77CC'.```.......``...`'.........             ..-:.``'_______-:+vvvvv+HXv--_-~~_~:--------CC~`=vv===v=vH00>--:^__v+HBH=^^_vC:C7v+v==~^=:~::=:~>>>>=^:=7=++'^:^_^'+7---__-___-'_-_---'``.....'.        
.'777CO^.`'`......``..```...........             .:'```-_______-=+vvvvv?XC-___=^--__-__-__-vHC=`^~=v=v~~O00C-_-^_-:v+HB?~~-:v>+?=O7=v=~=v~~~`_^:O>+~~___=v+7-_=_:_:~_---___---_-------'``.....'`        
..~CCCC+''``.....``..```......... ..             '_````_________+v+vvv7BH_''`:-``'-''''--'=HHO~'~vv==:^O0HO:-'_:--_v+HBC:^-^7~C+>=+C7==>C~~=.-^`~+=+~:~^^v>7'-v:~:+_-_-____--'----''--'``.....`'        
.. _>7>~````....``..```..........  .             _'``.'________^+vvv+7BB~...`_ .`^'.....'^HH?v::=~:___C007--'-^'--_=+HB>^_-~>^C>+_:::^_^7-_~___^:v>^`-'-v>7=`_:=~>_-__-___---''''''``````.....`'        
... `^~-':-...````.`'............               ':````'_______-^+vvvv0BO'...-:`'~_.....`_?H0>=^::____7007'-'`__''-_=vHB>^'_vv:7+>^''-:^^:^~__:-:OH+~_. .v7C+`:-+7^-__--____-''''''`... .``....`'.     `-
....`''-^v>:`.```````......... ..            `::='````'_______-~+vvvOB0:`...`++7_......'>B0?~:______>007'''`':''''-~vHX+:'_+~_>+=`:v==~^v7:-_~_^^=vv+>v->-^C~_'7+------____---'''`....   .`...`'.    ._^
...`'''''-^=^```````.........  ...           :^:^````.-_______-~+vv>0Bv`.`.. ~0^ .....`~0HH=_______700C-''``-_```'-~=?B=:`_>^'>v^-v`  .~>=::::=~:~^-__:+>`+O7-:>---------------`'`....   . ...`-.    .:^
..`'''''````-_'````..........  ......        ~_:_`````________-v+=vOB?_```'.'+:......'-7BHv_____-_700?:-````:`````'^=?B~:`->:'^>=^= .:+~-::^:~:^0C>~:~^'^-H0C->^-----_--------''`...      ....`'.    '==
..```..`````'``````.... ......... ...        ~_-`````'_______-=>=>HB0^-_-'`_~'......'->B0~_____-^?00v__'``.''.`````:~OBv_._7:-`~=^=:^__`v=+~`^-~> .'_~>=^7=OO=~------------''-`-'`.  .   ....`'-`  ..^++
..........``''``....... ..... .. ....        ^:-`````-_-____-^>+OBX?:-_-`.'-.....`.`'+B0=-____-~HB0=-_-`.`.-..`...._~CXv_._7:-`~_`~v-:-+=`'>--_=v .. _C==O>OCv--------_--''`''''.. .       .`''-` .._v++
.. .. .....```............  ....... ...      ^~'`````____-__-=>0BB7:''`..``........-=0B7-____-vH0H^__:-````-... .`.'^CXv:`_>^-`v>.:-_-v-.. v=`_+= . '>::+>BOC=----_-___----''.'`.. .    .````'`-`  '~+>+
.. .  ............... .....        ...       ~^`````'_____--_C0B?~'`...``.........`^HB?______+B00=_::^-''`-^-..:~=~~=7BC:`_7^-'v?v`_->- .  :>~==+='.v^:>O>CC7:----__--------`.'``.   . ..```''_~` .:v>>+
...... .............. ..          ..   . .. '~~'````'______^CB0+-`.......`'`....``:?B?^-____>B0O~_^^~^_-'`-'-_^^_-__~7B?:'_C~:'~>~=-_=^-`._v~^^_:vv=v:>=_OvO+---------------..'`...  ....-:=v-^~. `~+>>>
..  .      .........           ..  . ..  ...^_~'```.-___-~+CXB=``.``-_-`'_'``.`.`_?BC____-:O0H+::~^~~^_-`-`'`=_--___--~Hv_=C+:-~++>^~::~v:=^^-:_=~~=~+^ _H>O---------------`.`'....  ..`+?CO7_=_..-v>>>>
            ..   .               ...  ...`-~:_=-````-___v>vHB?'...`__`^:-..``..`-OBC_-:__^?0H=_^~~~~=^_'`- '._:-_--_-_-^O~=C>-_:>>>v+>v:vv^^~~:-_:=^:O+7??C>'----'''-------..'``. .....vBOOO+_~'..:v>>>>
             . ...       .  ....-__-_:^~v>+^__~:```'__-^Cv+0Bv``.`_'._^'.``.```_C0O:____~H0Hv:^~~~===:-`-' '.`:_--___--'^C~77-_'-=v+_'+>^~~^^'::^=~^~C>v>7?^------''''----`.`'`......._?OOOO~__`.`~+>>>>
 .              ..         ....-^v=v=v++++^_:_^~.`.'__->>v7B0:`.._- ^_`.``...'=?HH^-__-^HHH+^^~~====~:'`_. '-.''--_-__---:>OO:_-`+^==''+O^====^^~~====+7>+C--_----''''''-'  `'.... ...vHOOOC:````'=+>>>>
.                         . ..-:=vvvvvv+=^___:_^```-_-=Cv=?B?-.``:.`_````-:^=7?HC~___-=?HOv:~~====~~^-`'' ..:.`_`'---__---_vO>-_'=v=7+77?v=~vv^:~++vv7C7>O7-__-_--''''''-.  ``......._OOOOO7'````:+>>>>>
           `.           .  ..`:=vvvvv++^--_____^'``_-_C7v+0B?`..`^-:..'=7>+vv+>v_-__->HH7^^~~~=~=~~~_'`-. . --`-`.'--__---_-:H:-:-77C7++>>+++~v777O77BC^>$v--------'''-`.   '`.....``7?OOO?v'```'^>>>>>7
   ... _- :B_        .....  .-~vvvvvvv_-_______^'`'__+O>=>0B+.`..=O_`_CHC='''-----__=CC>^~~~===~~~~^-.-`    `:``' `-------__-:C-__??>>+>>7CCCO=~^7%7>XHvOH^---_----'-'`.   .``....`.~HOO?O?=`.```:>>>>77
    . :0: 'B_         ... ...^=vvv=v=_---______^_.-_^CCvv7BB_..`^+_`=?HOv'---''''''_:^~::^~~===~~~^:'.'.     _'`- .'---___---'~>-:H+OOOCC0+vB?====~~:^:^:~^-_''_--_-`.     `'```..``OOOOO?O:````.-7>>>77
   . `0O   C'         ... . '~vvvv+^----_-___-:v:.--+CCvvC0O`.`-_.'+0HHC:'-__----''''''--_:^~~~~-::-``'.. .  ._`-   '--_------'v~_COCX0v>X7v^__--'''-'-''-^-_-``''`.       .`..```.=HOOOO?7'''``.-777777
  ...7X^   :-  ..   .  . .. -~vv+=:--''-______v7='-~7O+v=CX=.```'~C0HC+:_--______~v=:--'''--__::_'-'`-'`..    --_` .`'--'------:C^~0OB0C>~'----'----'---'''----.            ``..``-OOOOOO?+``''..`77>777
..  v0v   . . '7_     ...   ^vv+~--'``'__-__-^>>+-~CCCvv^H0'..`~O0BO^_-_--______+??>~~~~^^::--'''`...```... ...__`. .''`''------=C`HH=__--_---------'--'''''--_`  .   . .   .'````7OOO????:` .....+C7777
....=v.   . ._>?=      ..  `~v+~_-'```'_--__-v+++~77?+v~=X7..->0B?+_____--_____+H?C~======~~~^^:_'. .''`.. ..`.`_`. .``'-''------OCv----__---'''-''-----'''''--` .'''`''''. =@```:?O+~v7Cv'`  H ..vC7777
-~=.. .     _OCC+      . ..`~+~-'`'```'_-_-__+++>>>7Ov+:+X~.vHB0>:-____-_-___:>??Hv=========~~~^:-. `'`..... ..._``...``'''----_:+^'-_-_----''''--'---''''`'''-` `-'7@#0@#0HH~'`.v?v---_-''    ...~C7777
7C+         `777~  .   ....'+~-'``````'__---:++>+>+?7vv:?H~OXBO^-_______-_^=7O??H>==========~~~^_'' `'`.....   ._'`...`.`''---_-=_'--------'``'`''''''-'''```'-` `'``v^`@0`'..'`:?=-____-'`.    ..~C777C
>>^          -+>-     . .. _~-'`'`````-_--_-~++++>>?+v=~HH00Cv___:_____:_~>????O>~==========~::-'`-'.'`.....    '^``` . '------_--------'--'``'..```'``````..`-..``.....@H.``.'>@+-B@__@0`.@= H ..=C77C7
>+:`        . -+`      ....:-`````````------=++++>vC=v~+00?~--______~vv:_~7CC>v==========~~^_-'`..'-.``..........:^``   `''-------''--'''-'`.`..    ..  .....`'..'`.....@H.`-.-?@_-B@-=@7 =@= H...vC7+~^
+>_:          ._. .  ....`:_`'````````---``_v+++>=+C==:CBC______-_~7O>^-_~=~~~=======~~~:_--''`...''` ```.......`'~-``  ..`'-'''''`--''-''`... ..   .`   .....'``'......@H``'`'C@__B@-B@`>@@=.H `-v::_--
=_`           .. .`:~... -:`''````````--``':++++=~>>=~_7+_______=C?O+^--:^~======~~~^:_-'''``....`''` .'``......``:^``.   .''`'''`'''`''`'`... .    .. .......'```......@H'`-:.+@_>@@-0@.0@@v.H``~:---__
  ..          .. 'v~:..`_:-'````````'`_-``'^+v++~~C>~:__-____-~CH?O>^--_^~===~~~~^:__--''````....``'`. .'``...  .``~'.. .  `'``'`.```.`.```         ..  ......'`''......@0`'v^.~#>@@@_0@=@.@v.H`:~----__
  `            . .`   '+O^-'`````````-_-``'^v+v=~=Ov:__:___-=7?H?7=:-_:~~~~~~^:___--''````.......```'.  .`''``..```-^``.. ..`...   .    ...       . ..........'`''.....`@0:+~_``B@@@>'H@XO.@=`B:^-------
  .              . . 'v7C+-'`````````-__'`-~++~~~=O~-_____^CHHHC~__-_^~~^^^::___--''''`````....`````'`. . .`'''``'``^_`..  ..           ..      ..  .........`'``'.....'@B7@@>'.'_+@'`H@H`'v@>C^--------
                  ..-=>77v-'`````````--_'`-~+~~~~+O^-__--v?HH?=--_--^^^:::____----'''`````````'`'```'``. .  .`''``'`-:``...`.           ..       ..........``'``''...H000XB0B='.`_+@'`....-~?+~_~^:_----
                 .  :v+=:--'`````````--_'`-v=~~=^vO^-_-^>O?O+:-__--:::_______-----'''''`''````````'''-''`.  .. ...''`_'``..`             . ..............`'`''''``..`''`~:-__-'..'_=````-+~=v_~.`-_^^^_-
                  ..::_--__-`````````--_-`:=~~=^-+C:-:vCOC+:-___--_:________----''''''''````'''----''''`.      .. .''-^````.           ..........```````''`'-`--'``''``-~--___-. '`..`.'=C^:-_~.    .':^
                  .''.__--_-````````'_-__`~=~^:_-77^=CO7v^-____''-______-__----'''''````'-'''-''````...     ..`''. ''`_:```.       .....``````````'''''''`'-'`'''''``'_^_____--. `'`.``_>+:__:: . ...  `
                 ... `_-----````````---_-^=:____:77CO7=_--____'````'-____---''''''''-_-_>+:_-`        .   .`''```'..`'`:^``........```````````''''-'```...``.````'_^~~^__-__-''. `'```:C7:-_:~`.  ......
                 ....__----_'```````----^=:-___-^C7C+_-______-`....`'-'''''-----''`_COC7+^:-`      ..``. .''`..```'..`''~-````````````````''''--''`..........````'-__--_-_--'`'...''`'>C^---^-..  .... .

 * 20200521:第一版
 * 20200602:完善批处理
 * 20200603:新增首选项设置
 * 20200604:新增拾色器、图片移动
 * 20200605:新增"最近打开过的文件"
 */
using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Linq;
using System.Collections;
using System.Text;
using System.Threading.Tasks;
using System.Windows.Forms;
using System.Windows.Forms.DataVisualization.Charting;
using System.IO;
using MaterialSkin;
using MaterialSkin.Animations;
using MaterialSkin.Controls;
using static Gmage.RollBack;
using static Gmage.ImageProcess;
using System.Threading;
namespace Gmage
{
    public partial class MainForm : MaterialForm
    {
       
        /// <summary>
        /// 消息处理
        /// </summary>
        /// <param name="e"></param>
        private void MessageManage(MessageEventArgs e)
        {
            switch (e.messageType)
            {
                case MessageType.ImageReading:
                    mPB_Bar.Visible = true;
                    Thread thread = new Thread(new ParameterizedThreadStart(SetImageShow));
                    thread.Start(e.FileNames);
                    break;
                case MessageType.RunTime:
                    break;
                case MessageType.Message:
                    SetImage_Control(e.Message);
                    break;
                case MessageType.Error:
                    break;
                case MessageType.DeadlyError:
                    MessageBox.Show(e.Message, "致命错误", MessageBoxButtons.OK, MessageBoxIcon.Error);
                    break;
                case MessageType.Progress:
                    if ((int)e.Progress < 100)
                    {
                        mPB_Bar.Value = (int)e.Progress;
                    }
                    else
                        mPB_Bar.Visible = false;
                    break;
                case MessageType.History:
                    AddHistoryItems(e.Message);
                    break;
            }
        }

        private void SubthreadMessageReceive(MessageEventArgs e)
        {
            try
            {
                if (this.IsHandleCreated && !this.IsDisposed)
                {
                    MessageEventHandler handler = new MessageEventHandler(MessageManage);
                    this.Invoke(handler, new object[] { e });
                }
            }
            catch (Exception)
            {
                //throw new Exception("", ex);
            }
        }
        #region 变量
        public Tools Tool{set; get;} = Tools.Empty;
        private Tools lastTool= Tools.Empty;
        private bool spaceUp = false;
        ToolTip toolTip = new ToolTip();
        int history_Count = 10;
        int history_Name_index = 1;
        public Bitmap ResultImage
        {
            set => col.Image = value; get => (Bitmap)col.Image;
        }

        public Bitmap initBitmap { set; get; }

        private Hashtable htTabImageName = new Hashtable();

        bool canDrag = false;

        //Bitmap 

        #endregion
        private readonly MaterialSkinManager materialSkinManager;
        public MainForm()
        {
            InitializeComponent();
            initBitmap = new Bitmap(1, 1);
            ResultImage = initBitmap.Clone() as Bitmap;
            materialSkinManager = MaterialSkinManager.Instance;
            materialSkinManager.AddFormToManage(this);
            materialSkinManager.Theme = MaterialSkinManager.Themes.DARK;
            materialSkinManager.ColorScheme =
                new ColorScheme(Primary.BlueGrey800, Primary.BlueGrey900,
                Primary.BlueGrey500, Accent.LightBlue200, TextShade.WHITE);
            menuStrip1.BackColor = ((int)Primary.BlueGrey900).ToColor();

            if(Config.WindowStateMax)
                WindowState = FormWindowState.Maximized;
            else
                WindowState = FormWindowState.Normal;

            //Mtb_Color
            tabPage1.BackColor = Color.FromArgb(255, 51, 51, 51);
            //groupBox1.BackColor = ((int)Primary.BlueGrey800).ToColor();
            tB_R.BackColor = Color.FromArgb(255, 51, 51, 51);
            tB_G.BackColor = Color.FromArgb(255, 51, 51, 51);
            tB_B.BackColor = Color.FromArgb(255, 51, 51, 51);

            SetColorRGB();
            // pTools.BackColor = Color.FromArgb(255, 55, 71, 79);
            messageClass.OnMessageSend += new MessageEventHandler(SubthreadMessageReceive);
            TsmiClick();
            TsmiThresholdClick();
            ToolsClickEvent();
            SetToolTipPromot();
            this.KeyDown += (sender, e) =>
            {
                if (e.KeyCode == Keys.Space)//空格键按下可移动图片，仿PS
                {
                    if (spaceUp)
                    {
                        lastTool = Tool;
                        spaceUp = false;
                        Tool = Tools.Move;
                    }
                }
            };
            this.KeyUp += (sender, e) =>
            {
                if (e.KeyCode == Keys.Space)
                {
                    Tool = lastTool;
                    spaceUp = true ;
                }
            };
            LoadHistory();
        }

        /// <summary>
        /// 设置按钮的提示文本
        /// </summary>
        private void SetToolTipPromot()
        {
            toolTip.SetToolTip(mFB_Cut, "裁剪");
            toolTip.SetToolTip(mFB_ColorPicker, "拾色器");
        }

        #region mtS_Selected及以上的控件功能
        private void btn_SelectImage_Click(object sender, EventArgs e)
        {
            ReadInitImage();
        }

        private void ReadInitImage()
        {
            OpenFileDialog oi = new OpenFileDialog
            {
                Filter = "图片(*.jpg,*.jpeg,*.bmp,*.png) | *.jpg;*.jpeg;*.bmp;*.png| 所有文件(*.*) | *.*",
                RestoreDirectory = true,
                FilterIndex = 1,
                Multiselect = true,
            };
            if (oi.ShowDialog() == DialogResult.OK)
            {
                RollBackMessage(oi.FileNames);
            }
        }

        private void SetImageShow(object fileNames)
        {
            var files = (string[])fileNames;
            var count = files.Count();
            float c = 0;
            foreach (var filename in files)
            {
                RollBackMessage(++c / count * 100f);
                SetImageShow(filename);
                RollBackMessage(filename, MessageType.History);
            }
            CheckonIndex();
        }

        private void SetImageShow(string filename)
        {
            var Format = new string[] { ".jpg", ".bmp", ".jpeg", ".png" };
            if (Format.Contains(Path.GetExtension(filename).ToLower()))
            {
                try
                {
                    RollBackMessage(filename);
                }
                catch (Exception ex)
                {
                    MessageBox.Show("不正确的格式", "错误的预期", MessageBoxButtons.OK, MessageBoxIcon.Error);
                }
            }
        }

        private void SetImage_Control(string filename)
        {
            try
            {
                var initImage = (Bitmap)Image.FromFile(filename);
                //ResultImage = initImage.Clone() as Bitmap; //严重的BUG 
                initBitmap = initImage.Clone() as Bitmap;
                if (mtS_Selected.BaseTabControl != mTC_ImageTab)
                {
                    mtS_Selected.BaseTabControl = mTC_ImageTab;
                    mTC_ImageTab.Visible = true;
                    panel1.Visible = false;
                }
                SetTab(Path.GetFileNameWithoutExtension(filename));
                if (!HideTab())
                {
                    materialContextMenuStrip1.Enabled = true;
                    tsm_CloseTabPage.Enabled = true;
                }
                else
                {
                    ResetBitmap();
                }
            }
            catch
            {
                MessageBox.Show("图片打开失败", "错误的预期", MessageBoxButtons.OK, MessageBoxIcon.Error);
            };
        }

        /// <summary>
        /// 打开文件时tabcontrol显示图片名字
        /// </summary>
        private void SetTab(string imageName)
        {
            imageName = reName(imageName);
            AddPagesIndex(imageName);
            TabPage t = new TabPage(imageName)
            {
                Name = "tp_" + imageName
            };
            mTC_ImageTab.TabPages.Add(t);
            PictureBox it = new PictureBox()
            {
                Name = "pb_" + imageName,
            };
            var tp = mTC_ImageTab.TabPages[t.Name];
            tp.Controls.Add(it);
            tp.BackColor = Color.FromArgb(255, 51, 51, 51);
            htTabImageName.Add(t.Name, it.Name);
            mTC_ImageTab.SelectedTab = tp;
            it.Dock = DockStyle.None;
            it.SizeMode = PictureBoxSizeMode.CenterImage;
            it.Image = initBitmap.Clone() as Image;
            it.Width = it.Image.Width;
            it.Height = it.Image.Height;
            var p = GetControlCenterLocation(tp, it);
            it.Location = p;
            it.Anchor = AnchorStyles.Left|AnchorStyles.Top;
            Point mouse_offset= new Point();

            it.MouseDown += (sender, e) =>
            {
                switch (Tool)
                {
                    default:
                    case Tools.Empty:
                        break;
                    case Tools.Move:
                        canDrag = true;
                        mouse_offset.X = -e.X;
                        mouse_offset.Y = -e.Y;
                        break;
                    case Tools.RGB_Pick:
                        var c = ((Bitmap)it.Image).GetPixel(e.X,e.Y);
                        Pick_RGB(c);
                        break;
                }
            };
            it.MouseMove += (sender, e) =>
            {
                it.Cursor = MouseCursor();
                switch (Tool)
                {
                    default:
                    case Tools.Empty:
                        break;
                    case Tools.Move:
                        if (e.Button == MouseButtons.Left&&canDrag)
                        {
                            it.Location =new Point(it.Left + e.X+ mouse_offset.X, it.Top + e.Y+ mouse_offset.Y);
                        }
                        break;
                    case Tools.RGB_Pick:
                        if (e.Button == MouseButtons.Left)
                        {
                            if (e.X > 0 && e.Y > 0&& e.X< it.Image.Width&&e.Y< it.Image.Height)
                            {
                                var c = ((Bitmap)it.Image).GetPixel(e.X, e.Y);
                                Pick_RGB(c);
                            }
                        }
                        break;
                }
            };
            it.MouseUp += (sender, e) =>
            {
                switch (Tool)
                {
                    case Tools.Move:
                        if (e.Button == MouseButtons.Left)
                        {
                            canDrag = false;
                        }
                        break;
                }
            };
        }
        /// <summary>
        /// 获取[里控件]居中于[外控件]时的左上角坐标
        /// </summary>
        /// <param name="outC"></param>
        /// <param name="inC"></param>
        /// <returns></returns>
        private Point GetControlCenterLocation(Control outC,Control inC)
        {
            var x = 0;
            var y = 0;

            var outW = outC.Width;
            var outH = outC.Height;

            var inW = inC.Width;
            var inH = inC.Height;

            x = (outW - inW) / 2;
            y = (outH - inH) / 2;

            x = x > 0 ? x : 0;
            y = y > 0 ? y : 0;

            return new Point(x, y);
        }

        HashSet<string> NameHash = new HashSet<string>();
        private string reName(string name)
        {
            string extension = Path.GetExtension(name);//扩展名
            string fileNameWithoutExtension = Path.GetFileNameWithoutExtension(name);// 没有扩展名的文件名
            if (!NameHash.Add(name))
            {
                return reName(fileNameWithoutExtension, fileNameWithoutExtension, extension, name);
            }
            return name;
        }

        /// <summary>
        /// 重命名
        /// </summary>
        /// <param name="fileNameWithoutExtension">无拓展名的文件名</param>
        /// <param name="original">原始无拓展名的文件名</param>
        /// <param name="extension">拓展名</param>
        /// <param name="name">有拓展名的文件名</param>
        /// <param name="serialNum">序号</param>
        /// <returns></returns>
        private string reName(string fileNameWithoutExtension, string original, string extension, string name, int serialNum = 1)
        {
            name = original + $"({serialNum.ToString()})" + extension;
            serialNum++;
            if (!NameHash.Add(name))
                return reName(fileNameWithoutExtension, original, extension, name, serialNum);
            return name;
        }
        Queue<string> history = new Queue<string>();
        private void SetHistory()
        {
            int index =1;
            history.Clear();
            HashSet<string> hs_history = new HashSet<string>();
            for (int j = 0; j < tsmi_History.DropDownItems.Count; j++)
            {
                SetHistory("history", $"history{index++}", tsmi_History.DropDownItems[j].Tag.ToString());
            }
        }

        private void LoadHistory()
        {
            for(int i = history_Count-1; i>0; i--)
            {
                var h = LoadHistory("history", $"history{i}", null);
                if (!string.IsNullOrEmpty(h))
                {
                    history.Enqueue(h);
                    AddHistoryItems(i, h);
                }
            }
        }

        /// <summary>
        /// 打开图片信息添加到最近打开
        /// </summary>
        private void AddHistoryItems(string filename)
        {
            AddHistoryItems(history_Count+history_Name_index, filename);
            history_Name_index++;//防止控件重名
            history.Enqueue(filename);//最近打开，最多history_Count项
            if (history.Count > history_Count)
                history.Dequeue();
        }
        private void AddHistoryItems(int i,string h)
        {
            ToolStripMenuItem items = new ToolStripMenuItem()
            {
                Name = $"tsmi_history{i}",
                Text = $"{h}",
                Tag = h,
            };
            items.Click += (sender, e) =>
            {
                tsmi_History.DropDownItems.Remove(items);//点击后当前item提前到第一行
               // tsmi_History.DropDownItems.Insert(0, items);
                string[] file = new string[] { (string)items.Tag };
                RollBackMessage(file);
                
                //for (int j = 0; j < tsmi_History.DropDownItems.Count; j++)
                //{
                //    tsmi_History.DropDownItems[j].Text = $"{j + 1} {tsmi_History.DropDownItems[j].Tag.ToString()}";
                //}
            };
            tsmi_History.DropDownItems.Insert(0, items);
            HashSet<string> hs_history = new HashSet<string>();
            for (int j = 0; j < tsmi_History.DropDownItems.Count; j++)//清除相同的记录,时间复杂度N2
            {
                if (!hs_history.Add(tsmi_History.DropDownItems[j].Tag.ToString()))
                {
                    tsmi_History.DropDownItems.RemoveAt(j);
                    j = -1;
                    hs_history.Clear();
                }
            }
            for (int j = 0; j < tsmi_History.DropDownItems.Count; j++)
            {
                tsmi_History.DropDownItems[j].Text = $"{j + 1} {tsmi_History.DropDownItems[j].Tag.ToString()}";
            }
        }

        private void SetHistory(string val1, string val2, string val3)
        {
            GmageConfigXML.XmlHandle.SaveControlValue("MainForm", val1, val2, val3);
        }

        private string LoadHistory(string val1, string val2, string val3)
        {
           return GmageConfigXML.XmlHandle.LoadPreferences(val1, val2, val3, "MainForm");
        }


        private void btn_Histogram_Click(object sender, EventArgs e)
        {
            Histogramcs hs = new Histogramcs(ResultImage);
            hs.ShowDialog();
        }

        private void btn_Salt_Click(object sender, EventArgs e)
        {
            Config.Model = FunctionType.Salt;
            Probability py = new Probability(this, MousePosition)
            {
                InitBitmap = ResultImage,
            };
            SetImageCallback(SaltNoise(ResultImage));
            py.ShowDialog();
        }

        public void SetImageCallback(Bitmap bitmap)
        {
            ResultImage = bitmap;
        }

        private void button2_Click(object sender, EventArgs e)
        {
            GmageConfigXML.XmlHandle.SetPreferences("Conventional", "HomePage", "1");
            Config.homePage = 1;
            Config.bReStart = true;
            Application.Exit();
        }

        private void btn_FaceRecognition_Click(object sender, EventArgs e)
        {
            Config.Model = FunctionType.FaceRecognition;
            if (Path.GetExtension(Config.ClassifierPath) == ".xml")
                ResultImage = Recognite_Face(ResultImage, Config.ClassifierPath);
            else
                MessageBox.Show("请先选择分类器", "", MessageBoxButtons.OK, MessageBoxIcon.Warning);
        }

        private void MainForm_Load(object sender, EventArgs e)
        {
            if (Program.MyArgs.Length > 0)
            {
                RollBackMessage(Program.MyArgs);
            }
            Classifier_Load();
            Change_pB_Color();
        }

        /// <summary>
        /// 
        /// </summary>
        private void Classifier_Load()
        {
            var path = Application.StartupPath + @"\Classifier\";
            config.FloderExist(path);
            DirectoryInfo dir = new DirectoryInfo(path);
            FileInfo[] fi = dir.GetFiles();
            if (fi.Length == 0)
                return;
            foreach (var f in fi)
            {
                if (f.Extension != ".xml")
                    continue;
                ToolStripMenuItem items = new ToolStripMenuItem()
                {
                    Name = f.Name,
                    Text = f.Name,
                    Tag = f.FullName,
                    CheckOnClick = true,
                };
                items.Click += tsmi_Classifier_Click;
                tsmi_Classifier.DropDownItems.Add(items);
            }
        }

        private void AddPagesIndex(string ImageName)
        {
            ToolStripMenuItem items = new ToolStripMenuItem()
            {
                Name = "tsmi_" + ImageName,
                Text = ImageName,
                Tag = "tp_" + ImageName,
                CheckOnClick = true,
            };
            items.Click += tsmi_Index_Click;
            tsmi_Index.DropDownItems.Add(items);
        }

        Config config = new Config();
        private void tsmi_Classifier_Click(object sender, EventArgs e)
        {
            Config.ClassifierPath = (string)((ToolStripMenuItem)sender).Name;
            config.IsCheckedControl((ToolStripMenuItem)sender, tsmi_Classifier);
        }

        private void tsmi_Index_Click(object sender, EventArgs e)
        {
            Config.ClassifierPath = ((ToolStripMenuItem)sender).Name;
            config.IsCheckedControl((ToolStripMenuItem)sender, tsmi_Index);
            mTC_ImageTab.SelectedTab = mTC_ImageTab.TabPages[((ToolStripMenuItem)sender).Tag.ToString()];
        }

        private void CheckonIndex()
        {
            int i = 0;
            foreach (ToolStripMenuItem item in tsmi_Index.DropDownItems)
            {
                if (i++ < tsmi_Index.DropDownItems.Count - 1)
                    continue;
                item.Checked = true; //设选中状态为true
            }
        }

        private void btn_Save_Click(object sender, EventArgs e)
        {
            SaveFileDialog sfd = new SaveFileDialog
            {
                Filter = "JPEG (*.jpg,*.jpeg) | *.jpg;*.jpeg",//设置文件类型
                FileName = Guid.NewGuid().ToString(),//设置默认文件名
                AddExtension = true//设置自动在文件名中添加扩展名
            };
            if (sfd.ShowDialog() == DialogResult.OK)
            {
                try
                {
                    ResultImage.Save(sfd.FileName, System.Drawing.Imaging.ImageFormat.Jpeg);
                    MessageBox.Show("保存成功");
                }
                catch { };
            }
        }

        private void Open_Threshold_Config(int hold = 128)
        {
            Process.Threshold ptd = new Process.Threshold(this, MousePosition, hold)
            {
                InitBitmap = ResultImage.Clone() as Bitmap,
            };
            ptd.ShowDialog();
        }

        private void tsmi_About_Click(object sender, EventArgs e)
        {
            //Clipboard.SetText("Iyui.Github.com");
        }

        PictureBox col = new PictureBox();
        private void materialTabSelector1_TabIndexChanged(object sender, EventArgs e)
        {
            ResetBitmap();
        }

        private void ResetBitmap()
        {
            if (mTC_ImageTab.SelectedTab is null)
                return;
            var TabName = mTC_ImageTab.SelectedTab.Name;
            var selectedTabName = (string)htTabImageName[TabName];

            config.IsCheckedControl(tsmi_Index, TabName);
            col = (PictureBox)mTC_ImageTab.SelectedTab.Controls.Find(selectedTabName, true)[0];
            if (!(col.Image is null))
                initBitmap = (Bitmap)col.Image;
        }

        private void tsm_CloseTabPage_Click(object sender, EventArgs e)
        {
            Remove();
            if (HideTab())
            {
                materialContextMenuStrip1.Enabled = false;
            }
        }

        /// <summary>
        /// 删除当前选中的选项卡
        /// </summary>
        public void Remove()
        {
            // 删除时判断是否还存在TabPage
            if (mTC_ImageTab.SelectedIndex > -1)
            {
                if (HideTab())
                    return;
                var SelectedTabName = mTC_ImageTab.SelectedTab.Name;
                var TabName = SelectedTabName.Substring(3);
                //使用TabControl控件的TabPages属性的Remove方法移除指定的选项卡
                htTabImageName.Remove(SelectedTabName);
                tsmi_Index.DropDownItems.RemoveByKey("tsmi_" + TabName);
                NameHash.Remove(TabName);
                mTC_ImageTab.TabPages.Remove(mTC_ImageTab.SelectedTab);
            }
        }

        private bool HideTab()
        {
            if (mTC_ImageTab.TabPages.Count < 2)
            {
                return true;
            }
            return false;
        }

        private void mTC_ImageTab_DragOver(object sender, DragEventArgs e)
        {
            if (e.Data.GetDataPresent(DataFormats.FileDrop))
            {
                e.Effect = DragDropEffects.Move;
            }
        }

        private void mTC_ImageTab_DragDrop(object sender, DragEventArgs e)
        {
            if (e.Data.GetDataPresent(DataFormats.FileDrop))
            {
                string[] file = (string[])e.Data.GetData(DataFormats.FileDrop);
                RollBackMessage(file);
            }
        }

        private void TsmiClick()
        {
            ToolStripMenuItem[] toolStripMenuItems = new ToolStripMenuItem[] 
            {
                tsmi_Gray,tsmi_Complementary,tsmi_Frequency,
                Clockwise180,Clockwise90,Clockwise270,RotateNoneFlipX,RotateNoneFlipY,
                Tsmi_GaussBlur,tsmi_MedianFilter,tsmi_GaussNoise,tsmi_Smoothed
            };
            foreach (var tsmi in toolStripMenuItems)
            {
                tsmi.Click += (click_sender, click_e) =>
                {
                    Config.Model = (FunctionType)Enum.Parse(typeof(FunctionType), tsmi.Tag.ToString());
                    ResultImage = SwitchFunc(ResultImage);
                };
            }
        }

        private void TsmiThresholdClick()
        {
            ToolStripMenuItem[] toolStripMenuItems = new ToolStripMenuItem[]
            {
               tsmi_Lighten,tsmi_Contrast,tsmi_Binarization,tsmi_Polar,tsmi_Robert,tsmi_Sharpen
            };
            foreach (var tsmi in toolStripMenuItems)
            {
                tsmi.Click += (click_sender, click_e) =>
                {
                    Config.Model = (FunctionType)Enum.Parse(typeof(FunctionType), tsmi.Tag.ToString());
                    //ResultImage = SwitchFunc(initBitmap);
                    Open_Threshold_Config(0);
                };
            }
        }

        private void tsmi_Clear_Click(object sender, EventArgs e)
        {
            ResultImage = initBitmap.Clone() as Bitmap ;
        }

        private void tsmi_Preferences_Click(object sender, EventArgs e)
        {
            Preferences preferences = new Preferences();
            preferences.ShowDialog();
        }
        #endregion

        #region 拾色器
#region 调色板
        private void pB_Color_Click(object sender, EventArgs e)
        {
            ColorDialog dlgColor = new ColorDialog();
            if (dlgColor.ShowDialog() == DialogResult.OK)
            {
                var c = dlgColor.Color;
                pB_Color.BackColor = c;
                Color_R = c.R;
                Color_G = c.G;
                Color_B = c.B;
            }
        }

        public int Color_R
        {
            get
            {
                int.TryParse(mT_R.Text, out int r);
                if (r > 255)
                    r = 255;
                if (r < 0)
                    r = 0;
                mT_R.Text = r.ToString();
                return r;
            }
            set
            {
                if (value > 255)
                {
                    mT_R.Text = 255.ToString();
                    return;
                }
                if (value < 0)
                {
                    mT_R.Text = 0.ToString();
                    return;
                }
                mT_R.Text = value.ToString();
            }
        }
        public int Color_G
        {
            get
            {
                int.TryParse(mT_G.Text,out int r);
                if (r > 255)
                    r = 255;
                if (r < 0)
                    r = 0;
                mT_G.Text = r.ToString();
                return r;
            }
            set
            {
                if (value > 255)
                {
                    mT_G.Text = 255.ToString();
                    return;
                }
                if (value < 0)
                {
                    mT_G.Text = 0.ToString();
                    return;
                }
                mT_G.Text = value.ToString();
            }
        }

        public int Color_B
        {
            get
            {
                int.TryParse(mT_B.Text, out int r);
                if (r > 255)
                   r= 255;
                if (r < 0)
                   r= 0;
                mT_B.Text = r.ToString();
                return r;
            }
            set
            {
                if (value > 255)
                {
                    mT_B.Text = 255.ToString();
                    return;
                }
                if (value < 0)
                {
                    mT_B.Text = 0.ToString();
                    return;
                }
                mT_B.Text = value.ToString();
            }
        }

        private void SetColorRGB()
        {
            mT_R.TextChanged += (sender, e) =>
            {
                tB_R.Value = Color_R;
                Change_pB_Color();
            };

            mT_G.TextChanged += (sender, e) =>
            {
                tB_G.Value = Color_G;
                Change_pB_Color();
            };

            mT_B.TextChanged += (sender, e) =>
            {
                tB_B.Value = Color_B;
                Change_pB_Color();
            };


            mT_R.KeyPress += InputLimit;

            mT_G.KeyPress += InputLimit;

            mT_B.KeyPress += InputLimit;

            tB_R.Scroll += (sender, e) =>
             {
                 Color_R = tB_R.Value;
             };

            tB_G.Scroll += (sender, e) =>
            {
                Color_G = tB_G.Value;
            };

            tB_B.Scroll += (sender, e) =>
            {
                Color_B = tB_B.Value;
            };

        }

        private void InputLimit(object sender, KeyPressEventArgs e)
        {
            if (((int)e.KeyChar < 48 && (int)e.KeyChar != 8) || ((int)e.KeyChar > 57))
            {
                e.Handled = true;
            }
        }

        private void Change_pB_Color()
        {
            pB_Color.BackColor = Color.FromArgb(Color_R, Color_G, Color_B);
        }

        #endregion

        #region 鼠标拾色
        Point p = MousePosition;
        
        private void Pick_RGB(Color c)
        {
            Color_R = c.R;
            Color_G = c.G;
            Color_B = c.B;
        }



        #endregion
        #endregion

        #region 左边工具栏
        private void ToolsClickEvent()
        {
            MaterialFlatButton[] flatButtons = new MaterialFlatButton[] { mFB_Select, mFB_ColorPicker, mFB_Move };
            foreach (var flatButton in flatButtons)
            {
                flatButton.Click += (sender, e) =>
                {
                    Tool = (Tools)Enum.Parse(typeof(Tools), flatButton.Tag.ToString());
                };
            }
        }

        private System.Windows.Forms.Cursor MouseCursor()
        {
            switch (Tool)
            {
                default:
                case Tools.Empty:
                    return Cursors.Default;
                case Tools.Move:
                    return Cursors.Hand;
                case Tools.Cut:
                case Tools.RGB_Pick:
                    return Cursors.Cross;
            }
        }

        #endregion

        private void MainForm_FormClosing(object sender, FormClosingEventArgs e)
        {
            SetHistory();
        }
    }

    public enum Tools
    {
        Empty,
        Move,
        Cut,
        RGB_Pick,
    }
}
